<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Administration – Mistral Pans</title>
  
  
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/admin.css">
  <link rel="stylesheet" href="css/teacher-form.css">
  <link href="js/vendor/quill.snow.css" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--admin-bg, #0f0e0d);
      color: var(--admin-text, #f5f3ef);
      min-height: 100vh;
    }
    
    .login-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .login-card { width: 100%; max-width: 400px; background: var(--admin-surface, #1a1815); border: 1px solid var(--admin-border, #2a2725); border-radius: 12px; padding: 2.5rem; }
    .login-header { text-align: center; margin-bottom: 2rem; }
    .login-logo { font-family: 'Fraunces', Georgia, serif; font-size: 1.5rem; color: var(--admin-accent, #0D7377); }
    .login-title { font-size: 1.25rem; color: var(--admin-text-muted, #a8a5a0); margin-top: 0.5rem; }
    .login-error { background: rgba(231,76,60,0.1); border: 1px solid #e74c3c; color: #e74c3c; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.875rem; }
    .login-error.show { display: block; }
    
    .admin-header { background: var(--admin-surface, #1a1815); border-bottom: 1px solid var(--admin-border, #2a2725); padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .admin-header__logo { font-family: 'Fraunces', Georgia, serif; font-size: 1.25rem; color: var(--admin-accent, #0D7377); text-decoration: none; }
    .admin-header__actions { display: flex; align-items: center; gap: 1rem; }
    .admin-header__user { font-size: 0.875rem; color: var(--admin-text-muted, #a8a5a0); }
    
    .admin-container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    
    .admin-form__group { margin-bottom: 1.25rem; }
    .admin-form__label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
    .admin-form__input, .admin-form__select, .admin-form__textarea { width: 100%; padding: 0.625rem 0.875rem; background: var(--admin-bg, #0f0e0d); border: 1px solid var(--admin-border, #2a2725); border-radius: 8px; color: var(--admin-text, #f5f3ef); font-size: 0.875rem; font-family: inherit; }
    .admin-form__input:focus, .admin-form__select:focus, .admin-form__textarea:focus { outline: none; border-color: var(--admin-accent, #0D7377); }
    .admin-form__textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    
    .searchable-select-container { position: relative; }
    .searchable-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--admin-surface, #1a1815); border: 1px solid var(--admin-border, #2a2725); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .searchable-dropdown.show { display: block; }
    .searchable-dropdown__item { padding: 0.625rem 0.875rem; cursor: pointer; transition: background 0.15s; }
    .searchable-dropdown__item:hover { background: var(--admin-surface-hover, #242220); }
    .searchable-dropdown__item-label { font-weight: 500; }
    .searchable-dropdown__item-subtitle { font-size: 0.75rem; color: var(--admin-text-muted, #a8a5a0); }
    
    .facture-lignes { display: flex; flex-direction: column; gap: 0.5rem; }
    .facture-ligne { display: grid; grid-template-columns: 1fr 80px 100px 100px 40px; gap: 0.5rem; align-items: center; }
    .facture-ligne input { padding: 0.5rem; }
    .facture-ligne button { padding: 0.5rem; background: transparent; border: none; color: var(--admin-text-muted); cursor: pointer; }
    .facture-ligne button:hover { color: var(--admin-error, #e74c3c); }
    .facture-totaux { margin-top: 1rem; text-align: right; }
    .facture-total-row { display: flex; justify-content: flex-end; gap: 2rem; padding: 0.5rem 0; }
    .facture-total-row--final { font-weight: 600; font-size: 1.1rem; border-top: 1px solid var(--admin-border); padding-top: 0.75rem; }
    
    .admin-tabs { display: flex; gap: 0.25rem; margin-bottom: 1.5rem; background: var(--admin-surface); padding: 0.25rem; border-radius: 8px; border: 1px solid var(--admin-border); flex-wrap: wrap; }
    .admin-tab { padding: 0.625rem 1rem; background: transparent; border: none; border-radius: 6px; color: var(--admin-text-muted); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .admin-tab:hover { color: var(--admin-text); }
    .admin-tab.active { background: var(--admin-accent); color: white; }
    .admin-tab__badge { background: rgba(255,255,255,0.2); padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    
    .admin-empty { text-align: center; padding: 3rem; color: var(--admin-text-muted); }
    .admin-empty__title { font-size: 1.125rem; margin-bottom: 0.5rem; }
    .admin-empty__text { font-size: 0.875rem; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-view" class="login-view">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">Mistral Pans</div>
        <h2 class="login-title">Administration</h2>
      </div>
      <div id="login-error" class="login-error">Identifiants incorrects</div>
      <form id="login-form">
        <div class="admin-form__group"><label class="admin-form__label" for="username">Email</label><input type="email" class="admin-form__input" id="username" placeholder="admin@mistralpans.fr" autocomplete="username" required></div>
        <div class="admin-form__group"><label class="admin-form__label" for="password">Mot de passe</label><input type="password" class="admin-form__input" id="password" autocomplete="current-password" required></div>
        <button type="submit" class="admin-btn admin-btn--primary" style="width:100%;">Connexion</button>
      </form>
      <div style="text-align:center;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--admin-border);"><a href="index.html" style="color:var(--admin-text-muted);text-decoration:none;font-size:0.875rem;">← Retour au site</a></div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin-view" style="display:none;">
    <header class="header header--admin">
      <div class="header__inner">
        <a href="index.html" class="logo">
          <img src="ressources/images/Mistral_logov3_ball_black.png" alt="Mistral Pans" class="logo__img">
          <span class="logo__text">Mistral Pans</span>
        </a>
        
        <nav class="nav">
          <ul class="nav__list">
            <li><a href="boutique.html" class="nav__link">Boutique</a></li>
            <li><a href="location.html" class="nav__link">Location</a></li>
            <li><a href="apprendre.html" class="nav__link">Apprendre</a></li>
            <li><a href="galerie.html" class="nav__link">Galerie</a></li>
            <li><a href="blog.html" class="nav__link">Blog</a></li>
            <li><a href="#" class="nav__link" data-modal="contact">Contact</a></li>
          </ul>
          
          <div class="nav__admin">
            <span class="nav__admin-badge">Admin</span>
            <button class="nav__logout-btn" id="btn-logout" title="Déconnexion">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
            </button>
          </div>
          
          <button class="nav__toggle" aria-label="Menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </nav>
      </div>
    </header>
    
    <main id="main-content" class="admin-container">
      <!-- NAV -->
      <nav class="gestion-nav" id="gestion-nav">
        <button class="gestion-nav__item gestion-nav__item--dashboard" data-section="dashboard">Tableau de bord</button>
        <span class="gestion-nav__label">Gestion</span>
        <button class="gestion-nav__item" data-section="commandes">Commandes <span class="gestion-nav__badge" id="badge-commandes" style="display:none;">0</span></button>
        <button class="gestion-nav__item" data-section="instruments">Instruments</button>
        <button class="gestion-nav__item" data-section="clients">Clients</button>
        <button class="gestion-nav__item" data-section="locations">Locations <span class="gestion-nav__badge" id="badge-locations" style="display:none;">0</span></button>
        <button class="gestion-nav__item" data-section="factures">Factures</button>
        <span class="gestion-nav__label">Contenu</span>
        <button class="gestion-nav__item" data-section="boutique">Vitrine</button>
        <button class="gestion-nav__item" data-section="galerie">Galerie</button>
        <button class="gestion-nav__item" data-section="blog">Blog</button>
        <button class="gestion-nav__item" data-section="professeurs">Professeurs <span class="gestion-nav__badge" id="badge-professeurs" style="display:none;">0</span></button>
        <span class="gestion-nav__label">Outils</span>
        <button class="gestion-nav__item" data-section="comptabilite">Comptabilité</button>
        <button class="gestion-nav__item" data-section="config">Config</button>
      </nav>

      <!-- DASHBOARD -->
      <section class="dashboard" id="dashboard-section">
        <h1 class="dashboard__title">Tableau de bord</h1>
        <div class="dashboard__grid">
          <div class="dashboard__card">
            <div class="dashboard__card-title">Actions en attente</div>
            <div class="quick-actions">
              <button class="quick-action" onclick="AdminUI.goToTab('professeurs')"><span class="quick-action__label">Demandes professeurs</span><span class="quick-action__badge" id="dash-pending-teachers">0</span></button>
              <button class="quick-action" onclick="AdminUI.goToTab('commandes')"><span class="quick-action__label">Commandes en cours</span><span class="quick-action__badge" id="dash-pending-orders">0</span></button>
              <button class="quick-action" onclick="AdminUI.goToTab('factures')"><span class="quick-action__label">Paiements en attente</span><span class="quick-action__badge quick-action__badge--warning" id="dash-pending-payments">0</span></button>
            </div>
          </div>
          <div class="dashboard__card">
            <div class="dashboard__card-title">Statistiques business</div>
            <div class="stats-grid">
              <div class="stat-item"><div class="stat-item__value" id="dash-locations">0</div><div class="stat-item__label">Locations actives</div></div>
              <div class="stat-item"><div class="stat-item__value" id="dash-instruments">0</div><div class="stat-item__label">Instruments dispo</div></div>
              <div class="stat-item"><div class="stat-item__value" id="dash-ca-mois">0 €</div><div class="stat-item__label">CA ce mois</div></div>
              <div class="stat-item"><div class="stat-item__value" id="dash-ca-annee">0 €</div><div class="stat-item__label">CA cette année</div></div>
            </div>
          </div>
          <div class="dashboard__card dashboard__card--wide">
            <div class="dashboard__card-title">Ma liste de tâches</div>
            <div class="todo-list" id="todo-list"></div>
            <div class="todo-add"><input type="text" class="todo-add__input" id="todo-input" placeholder="Nouvelle tâche..." onkeypress="if(event.key==='Enter')AdminUI.addTodo()"><button class="todo-add__btn" onclick="AdminUI.addTodo()">Ajouter</button></div>
          </div>
          <div class="dashboard__card dashboard__card--wide">
            <div class="dashboard__card-title" style="display: flex; justify-content: space-between; align-items: center;">
              Statistiques du site
              <select class="admin-form__select" id="stats-period" style="width:auto; font-size: 0.8rem;" onchange="if(AdminUI.renderAnalytics)AdminUI.renderAnalytics()">
                <option value="7">7 jours</option>
                <option value="30" selected>30 jours</option>
                <option value="90">90 jours</option>
              </select>
            </div>
            <div id="stats-content"><p style="color:var(--admin-text-muted);">Chargement...</p></div>
          </div>
          <div class="dashboard__card" id="vendor-check-container">
            <div class="dashboard__card-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
              </svg>
              Librairies vendor
              <span id="vendor-badge" class="quick-action__badge" style="display:none;">0</span>
            </div>
            <div id="vendor-check-content">
              <div style="color: var(--admin-text-muted); font-size: 0.875rem;">Chargement...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- FACTURES -->
      <section class="gestion-section" id="section-factures">
        <div class="section-header"><h2 class="section-title">Gestion des factures</h2><div class="section-actions"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('facture')">+ Nouvelle facture</button></div></div>
        <div class="gestion-table-container"><table class="gestion-table"><thead><tr><th>N° Facture</th><th>Date</th><th>Client</th><th>Type</th><th>Montant</th><th>Statut</th><th style="text-align:right;">Actions</th></tr></thead><tbody id="table-factures"></tbody></table></div>
        <div class="gestion-empty" id="empty-factures" style="display:none;"><p class="gestion-empty__text">Aucune facture</p></div>
      </section>
      
      <!-- CLIENTS -->
      <section class="gestion-section" id="section-clients">
        <div class="section-header"><h2 class="section-title">Gestion des clients</h2><div class="section-actions"><input type="text" class="admin-form__input" style="max-width:250px;" placeholder="Rechercher..." id="search-clients" aria-label="Rechercher un client" oninput="AdminUI.searchClients(this.value)"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('client')">+ Nouveau client</button></div></div>
        <div class="gestion-table-container"><table class="gestion-table"><thead><tr><th>Nom</th><th>Email</th><th>Téléphone</th><th>Locations</th><th>Crédit fidélité</th><th style="text-align:right;">Actions</th></tr></thead><tbody id="table-clients"></tbody></table></div>
        <div class="gestion-empty" id="empty-clients" style="display:none;"><p class="gestion-empty__text">Aucun client</p></div>
      </section>
      
      <!-- INSTRUMENTS -->
      <section class="gestion-section" id="section-instruments">
        <div class="section-header"><h2 class="section-title">Gestion des instruments</h2><div class="section-actions"><input type="text" class="admin-form__input" style="max-width:250px;" placeholder="Rechercher..." id="search-instruments" aria-label="Rechercher un instrument" oninput="AdminUI.searchInstruments(this.value)"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('instrument')">+ Nouvel instrument</button></div></div>
        <div class="gestion-table-container"><table class="gestion-table"><thead><tr><th>Référence</th><th>Nom</th><th>Gamme</th><th>Statut</th><th>Prix</th><th>Boutique</th><th style="text-align:right;">Actions</th></tr></thead><tbody id="table-instruments"></tbody></table></div>
        <div class="gestion-empty" id="empty-instruments" style="display:none;"><p class="gestion-empty__text">Aucun instrument</p></div>
      </section>
      
      <!-- LOCATIONS -->
      <section class="gestion-section" id="section-locations">
        <div class="section-header"><h2 class="section-title">Gestion des locations</h2><div class="section-actions"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('location')">+ Nouvelle location</button></div></div>
        <div class="gestion-table-container"><table class="gestion-table"><thead><tr><th>Client</th><th>Instrument</th><th>Début</th><th>Mode</th><th>Loyer</th><th>Caution</th><th>Statut</th><th style="text-align:right;">Actions</th></tr></thead><tbody id="table-locations"></tbody></table></div>
        <div class="gestion-empty" id="empty-locations" style="display:none;"><p class="gestion-empty__text">Aucune location</p></div>
      </section>
      
      <!-- COMMANDES -->
      <section class="gestion-section" id="section-commandes">
        <div class="section-header"><h2 class="section-title">Gestion des commandes</h2><div class="section-actions"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('commande')">+ Nouvelle commande</button></div></div>
        <div class="gestion-table-container"><table class="gestion-table"><thead><tr><th>Date</th><th>Client</th><th>Description</th><th>Montant</th><th>Paiement</th><th>Statut</th><th style="text-align:right;">Actions</th></tr></thead><tbody id="table-commandes"></tbody></table></div>
        <div class="gestion-empty" id="empty-commandes" style="display:none;"><p class="gestion-empty__text">Aucune commande</p></div>
      </section>
      
      <!-- BOUTIQUE -->
      <section class="gestion-section" id="section-boutique">
        <div class="section-header"><h2 class="section-title">Gestion de la vitrine</h2></div>
        <div class="admin-tabs" role="tablist">
          <button class="admin-tab active" data-subtab="boutique-instruments">Instruments</button>
          <button class="admin-tab" data-subtab="boutique-accessoires">Accessoires</button>
        </div>
        
        <!-- Sous-onglet Instruments -->
        <div id="subtab-boutique-instruments">
          <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
            <div class="searchable-select-container" style="flex: 1; min-width: 250px; max-width: 400px;">
              <input type="text" class="admin-form__input searchable-input" id="boutique-instrument-search" placeholder="Sélectionner un instrument à publier..." autocomplete="off">
              <div class="searchable-dropdown" id="boutique-instrument-dropdown"></div>
            </div>
            <button class="admin-btn admin-btn--primary" onclick="AdminUI.publierInstrumentSelectionne()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Publier
            </button>
            <button class="admin-btn admin-btn--secondary" onclick="AdminUI.creerEtPublierInstrument()">+ Créer un instrument</button>
          </div>
          <div class="annonce-grid" id="boutique-instruments-list"></div>
          <div class="admin-empty" id="boutique-instruments-empty" style="display:none;">
            <div class="admin-empty__title">Aucun instrument en ligne</div>
            <p style="color: var(--admin-text-muted);">Sélectionnez un instrument ci-dessus pour le publier</p>
          </div>
        </div>
        
        <!-- Sous-onglet Accessoires -->
        <div id="subtab-boutique-accessoires" style="display:none;">
          <div style="margin-bottom: 1rem;">
            <button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('accessoire')">+ Nouvel accessoire</button>
          </div>
          <div class="annonce-grid" id="boutique-accessoires-list"></div>
          <div class="admin-empty" id="boutique-accessoires-empty" style="display:none;">
            <div class="admin-empty__title">Aucun accessoire</div>
            <p style="color: var(--admin-text-muted);">Ajoutez des housses, huiles, supports...</p>
          </div>
        </div>
      </section>
      
      <!-- PROFESSEURS -->
      <section class="gestion-section" id="section-professeurs">
        <div class="section-header"><h2 class="section-title">Gestion des professeurs</h2></div>
        <div class="admin-tabs" role="tablist"><button class="admin-tab active" data-subtab="pending">Demandes <span class="admin-tab__badge" id="pending-count">0</span></button><button class="admin-tab" data-subtab="active">Actifs</button><button class="admin-tab" data-subtab="add">Ajouter</button></div>
        <div id="subtab-pending"><div class="admin-list" id="pending-teachers-list"></div><div class="admin-empty" id="empty-pending" style="display:none;"><div class="admin-empty__title">Aucune demande</div></div></div>
        <div id="subtab-active" style="display:none;"><div class="admin-list" id="active-teachers-list"></div><div class="admin-empty" id="empty-teachers" style="display:none;"><div class="admin-empty__title">Aucun professeur</div></div></div>
        <div id="subtab-add" style="display:none;"><div class="admin-card" style="max-width:700px; background:#fff; color:#333;"><div id="add-teacher-form-container"></div><div style="margin-top: 1.5rem;"><button type="button" class="admin-btn admin-btn--primary" onclick="AdminUI.submitAddTeacherForm()">Ajouter le professeur</button></div></div></div>
      </section>
      
      <!-- GALERIE -->
      <section class="gestion-section" id="section-galerie">
        <div class="section-header"><h2 class="section-title">Gestion de la galerie</h2><div class="section-actions"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('media')">+ Ajouter un média</button></div></div>
        <div class="gallery-grid" id="gallery-grid"></div>
        <div class="admin-empty" id="gallery-empty" style="display:none;"><div class="admin-empty__title">Galerie vide</div></div>
      </section>
      
      <!-- BLOG -->
      <section class="gestion-section" id="section-blog">
        <div class="section-header"><h2 class="section-title">Gestion du blog</h2><div class="section-actions"><button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('article')">+ Nouvel article</button></div></div>
        <div id="articles-list"></div>
        <div class="admin-empty" id="articles-empty" style="display:none;"><div class="admin-empty__title">Aucun article</div></div>
      </section>
      
      <!-- COMPTABILITÉ -->
      <section class="gestion-section" id="section-comptabilite">
        <div class="section-header">
          <h2 class="section-title">Comptabilité & URSSAF</h2>
          <div class="section-actions">
            <select class="admin-form__select" id="compta-mois" style="width:auto;"></select>
            <button class="admin-btn admin-btn--secondary" onclick="AdminUI.genererRapportMensuel()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Télécharger PDF
            </button>
            <button class="admin-btn admin-btn--primary" onclick="AdminUI.envoyerRapportMensuel()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              Envoyer par email
            </button>
          </div>
        </div>
        
        <!-- Résumé URSSAF -->
        <div class="stats-grid" style="margin-bottom: 2rem;">
          <div class="dashboard__card">
            <div class="dashboard__card-title">BIC - Ventes & Locations</div>
            <div class="dashboard__card-subtitle">Ventes instruments, accessoires, locations</div>
            <div class="dashboard__card-value" id="compta-bic">0 €</div>
          </div>
          <div class="dashboard__card">
            <div class="dashboard__card-title">BNC - Prestations</div>
            <div class="dashboard__card-subtitle">Cours, formations, services</div>
            <div class="dashboard__card-value" id="compta-bnc">0 €</div>
          </div>
          <div class="dashboard__card">
            <div class="dashboard__card-title">Total CA du mois</div>
            <div class="dashboard__card-subtitle">Factures payées</div>
            <div class="dashboard__card-value" id="compta-total">0 €</div>
          </div>
        </div>
        
        <!-- Détail des factures du mois -->
        <div class="dashboard__card" style="margin-bottom: 2rem;">
          <div class="dashboard__card-title">Détail des factures du mois</div>
          <div class="gestion-table-container" style="margin-top: 1rem;">
            <table class="gestion-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>N° Facture</th>
                  <th>Client</th>
                  <th>Type</th>
                  <th>Catégorie</th>
                  <th style="text-align:right;">Montant</th>
                </tr>
              </thead>
              <tbody id="compta-factures-list"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Configuration email automatique -->
        <div class="dashboard__card">
          <div class="dashboard__card-title">Envoi automatique mensuel</div>
          <div class="admin-form__group" style="margin-top: 1rem;">
            <div class="admin-form__checkbox">
              <input type="checkbox" id="compta-auto-email">
              <label for="compta-auto-email">Activer l'envoi automatique le 1er de chaque mois</label>
            </div>
          </div>
          <div class="admin-form__group">
            <label class="admin-form__label">Email de destination</label>
            <input type="email" class="admin-form__input" id="compta-email-dest" placeholder="comptabilite@example.com" style="max-width: 400px;">
          </div>
          <div class="admin-form__group">
            <label class="admin-form__label">Contenu du rapport</label>
            <div class="admin-form__checkbox">
              <input type="checkbox" id="compta-include-analytics" checked>
              <label for="compta-include-analytics">Inclure les statistiques du site</label>
            </div>
            <div class="admin-form__checkbox">
              <input type="checkbox" id="compta-include-factures" checked>
              <label for="compta-include-factures">Inclure le détail des factures</label>
            </div>
            <div class="admin-form__checkbox">
              <input type="checkbox" id="compta-include-pdf" checked>
              <label for="compta-include-pdf">Joindre les factures en PDF</label>
            </div>
          </div>
          <button class="admin-btn admin-btn--secondary" onclick="AdminUI.saveComptaConfig()">Enregistrer la configuration</button>
        </div>
      </section>
      
      <!-- CONFIG -->
      <section class="gestion-section" id="section-config">
        <div class="section-header"><h2 class="section-title">Configuration</h2></div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;">

          <!-- GESTION DES MATÉRIAUX -->
          <div class="dashboard__card dashboard__card--wide" style="grid-column: 1 / -1;">
            <div class="dashboard__card-title">Matériaux disponibles</div>
            <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-bottom: 1rem;">Gérez les matériaux disponibles dans le configurateur boutique. Vous pouvez activer/désactiver chaque matériau.</p>
            <div id="materiaux-list" class="materiaux-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
              <!-- Populated by JS -->
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
              <button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('materiau')">+ Ajouter un matériau</button>
              <button class="admin-btn admin-btn--secondary" onclick="AdminUI.resetMateriaux()">Réinitialiser par défaut</button>
            </div>
          </div>

          <!-- GESTION DES GAMMES -->
          <div class="dashboard__card dashboard__card--wide" style="grid-column: 1 / -1;">
            <div class="dashboard__card-title">Gammes disponibles</div>
            <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-bottom: 1rem;">Gérez les gammes disponibles. Les gammes marquées "Configurateur" apparaissent dans le configurateur boutique.</p>
            <div id="gammes-list" class="materiaux-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
              <!-- Populated by JS -->
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
              <button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('gamme')">+ Ajouter une gamme</button>
              <button class="admin-btn admin-btn--secondary" onclick="AdminUI.resetGammes()">Réinitialiser par défaut</button>
            </div>
          </div>

          <!-- GESTION DES TAILLES -->
          <div class="dashboard__card dashboard__card--wide" style="grid-column: 1 / -1;">
            <div class="dashboard__card-title">Tailles disponibles</div>
            <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-bottom: 1rem;">Gérez les tailles de handpan disponibles avec leurs malus de prix et paramètres de faisabilité.</p>
            <div id="tailles-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
              <!-- Populated by JS -->
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
              <button class="admin-btn admin-btn--primary" onclick="AdminUI.showModal('taille')">+ Ajouter une taille</button>
              <button class="admin-btn admin-btn--secondary" onclick="AdminUI.resetTailles()">Réinitialiser par défaut</button>
            </div>
          </div>

          <div class="dashboard__card">
            <div class="dashboard__card-title">Informations entreprise</div>
            <div class="admin-form__group"><label class="admin-form__label">Nom</label><input type="text" class="admin-form__input" id="config-nom" value=""></div>
            <div class="admin-form__group"><label class="admin-form__label">SIRET</label><input type="text" class="admin-form__input" id="config-siret" value=""></div>
            <div class="admin-form__group"><label class="admin-form__label">Email</label><input type="email" class="admin-form__input" id="config-email" value=""></div>
            <div class="admin-form__group"><label class="admin-form__label">Téléphone</label><input type="tel" class="admin-form__input" id="config-tel" value=""></div>
            <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveConfig()">Enregistrer</button>
          </div>
          <div class="dashboard__card">
            <div class="dashboard__card-title">Tarifs par défaut</div>
            <div class="admin-form__group"><label class="admin-form__label">Loyer (€)</label><input type="number" class="admin-form__input" id="config-loyer" value="50"></div>
            <div class="admin-form__group"><label class="admin-form__label">Caution (€)</label><input type="number" class="admin-form__input" id="config-caution" value="1150"></div>
            <div class="admin-form__group"><label class="admin-form__label">Frais distance (€)</label><input type="number" class="admin-form__input" id="config-frais" value="100"></div>
            <div class="admin-form__group"><label class="admin-form__label">Crédit fidélité (%)</label><input type="number" class="admin-form__input" id="config-fidelite" value="50" min="0" max="100"></div>
            <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveConfig()">Enregistrer</button>
          </div>
          <div class="dashboard__card">
            <div class="dashboard__card-title">Tarification configurateur</div>
            <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-bottom: 0.75rem;">
              Prix de base utilisés par le configurateur de la boutique.
            </p>
            <div class="admin-form__group"><label class="admin-form__label">Prix par note (€)</label><input type="number" class="admin-form__input" id="config-prix-note" value="115" min="0" step="5"></div>
            <div class="admin-form__group"><label class="admin-form__label">Bonus octave 2 (€/note)</label><input type="number" class="admin-form__input" id="config-bonus-octave2" value="50" min="0" step="5"></div>
            <div class="admin-form__group"><label class="admin-form__label">Bonus bottoms (€)</label><input type="number" class="admin-form__input" id="config-bonus-bottoms" value="25" min="0" step="5"></div>
            <div class="admin-form__group"><label class="admin-form__label">Malus difficulté warning (%)</label><input type="number" class="admin-form__input" id="config-malus-warning" value="5" min="0" max="100" step="1"></div>
            <div class="admin-form__group"><label class="admin-form__label">Malus difficulté difficile (%)</label><input type="number" class="admin-form__input" id="config-malus-difficile" value="10" min="0" max="100" step="1"></div>
            <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveConfig()">Enregistrer</button>
          </div>
          <!-- EMAILS AUTOMATIQUES -->
          <div class="dashboard__card dashboard__card--wide" style="grid-column: 1 / -1;">
            <div class="dashboard__card-title">Emails automatiques</div>
            <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-bottom: 1rem;">
              Configurez les emails envoyés automatiquement lors des changements de statut des commandes.
            </p>
            <div id="email-automations-list" style="display: flex; flex-direction: column; gap: 1rem;">
              <!-- Populated by JS -->
            </div>
            <div style="margin-top: 1rem;">
              <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveEmailConfig()">Enregistrer</button>
              <button class="admin-btn admin-btn--secondary" style="margin-left: 0.5rem;" onclick="AdminUI.testEmailAutomation()">Envoyer un test</button>
            </div>
          </div>

          <div class="dashboard__card">
            <div class="dashboard__card-title">Données</div>
            <div style="display:flex;flex-direction:column;gap:0.75rem;">
              <button class="admin-btn admin-btn--secondary" onclick="AdminUI.exportAllData()">Exporter</button>
              <button class="admin-btn admin-btn--secondary" onclick="document.getElementById('import-file').click()">Importer</button>
              <input type="file" id="import-file" accept=".json" style="display:none;" onchange="AdminUI.importData(this.files[0])">
              <hr style="border-color:var(--admin-border);margin:0.5rem 0;">
              <button class="admin-btn admin-btn--danger" onclick="AdminUI.resetAllData()">Réinitialiser</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-client"><div class="admin-modal"><div class="admin-modal__header"><h3 class="admin-modal__title" id="modal-client-title">Nouveau client</h3><button class="admin-modal__close" onclick="AdminUI.closeModal('client')">✕</button></div><div class="admin-modal__body"><form id="form-client"><input type="hidden" id="client-id"><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Prénom *</label><input type="text" class="admin-form__input" id="client-prenom" required></div><div class="admin-form__group"><label class="admin-form__label">Nom *</label><input type="text" class="admin-form__input" id="client-nom" required></div></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Email</label><input type="email" class="admin-form__input" id="client-email"></div><div class="admin-form__group"><label class="admin-form__label">Téléphone</label><input type="tel" class="admin-form__input" id="client-telephone"></div></div><div class="admin-form__group"><label class="admin-form__label">Adresse</label><textarea class="admin-form__textarea" id="client-adresse" rows="2"></textarea></div><div class="admin-form__group"><label class="admin-form__label">Notes</label><textarea class="admin-form__textarea" id="client-notes" rows="2"></textarea></div></form></div><div class="admin-modal__footer"><button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('client')">Annuler</button><button class="admin-btn admin-btn--primary" onclick="AdminUI.saveClient()">Enregistrer</button></div></div></div>

  <div class="admin-modal-overlay admin-modal--large" id="modal-instrument">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-instrument-title">Nouvel instrument</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('instrument')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-instrument">
          <input type="hidden" id="instrument-id">
          
          <!-- Référence générée automatiquement -->
          <div class="admin-form__group" style="background: var(--admin-surface-hover); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <label class="admin-form__label" style="color: var(--admin-accent);">Référence (auto-générée)</label>
            <input type="text" class="admin-form__input" id="instrument-reference" readonly style="font-family: monospace; font-weight: 600; background: var(--admin-surface);">
            <div class="admin-form__hint">Format: MP-HP-[Matériau]-[Tonalité] [Gamme] [Notes en chiffres romains]-[Numéro]</div>
          </div>
          
          <!-- Ligne 1: Numéro + Nom -->
          <div class="form-row">
            <div class="admin-form__group" style="max-width: 120px;">
              <label class="admin-form__label">N° série *</label>
              <input type="text" class="admin-form__input" id="instrument-numero" placeholder="00102" required oninput="AdminUI.updateInstrumentReference()">
            </div>
            <div class="admin-form__group" style="flex: 1;">
              <label class="admin-form__label">Nom commercial</label>
              <input type="text" class="admin-form__input" id="instrument-nom" placeholder="Kurd doré profond">
            </div>
          </div>
          
          <!-- Ligne 2: Tonalité + Gamme -->
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Tonalité *</label>
              <select class="admin-form__select" id="instrument-tonalite" required onchange="AdminUI.updateInstrumentReference()">
                <option value="">--</option>
                <option value="C">C (Do)</option>
                <option value="C#">C# (Do#)</option>
                <option value="D">D (Ré)</option>
                <option value="D#">D# (Ré#)</option>
                <option value="E">E (Mi)</option>
                <option value="F">F (Fa)</option>
                <option value="F#">F# (Fa#)</option>
                <option value="G">G (Sol)</option>
                <option value="G#">G# (Sol#)</option>
                <option value="A">A (La)</option>
                <option value="A#">A# (La#)</option>
                <option value="B">B (Si)</option>
              </select>
            </div>
            <div class="admin-form__group" style="position: relative;">
              <label class="admin-form__label">Gamme *</label>
              <input type="hidden" id="instrument-gamme" required>
              <input type="text" class="admin-form__input" id="instrument-gamme-search" placeholder="Rechercher une gamme..." autocomplete="off" oninput="AdminUI.filterGammeDropdown(this.value)" onfocus="AdminUI.filterGammeDropdown(this.value)">
              <div class="searchable-dropdown" id="instrument-gamme-dropdown" style="display:none;">
                <!-- Populated dynamically by AdminUI.populateGammesSelect() -->
              </div>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Notes *</label>
              <input type="number" class="admin-form__input" id="instrument-notes" min="7" max="36" value="9" required onchange="AdminUI.updateInstrumentReference()">
            </div>
          </div>
          
          <!-- Ligne 3: Matériau + Taille + Accordage -->
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Matériau *</label>
              <select class="admin-form__select" id="instrument-materiau" required onchange="AdminUI.updateInstrumentReference()">
                <!-- Options populated dynamically by AdminUI.populateMateriauxSelect() -->
              </select>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Taille</label>
              <select class="admin-form__select" id="instrument-taille">
                <!-- Populated dynamically by AdminUI.populateTaillesSelect() -->
              </select>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Accordage</label>
              <select class="admin-form__select" id="instrument-accordage">
                <option value="440" selected>440 Hz</option>
                <option value="432">432 Hz</option>
              </select>
            </div>
          </div>
          
          <!-- Ligne 4: Prix + Statut -->
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Prix (€)</label>
              <input type="number" class="admin-form__input" id="instrument-prix" min="0" step="5">
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Statut</label>
              <select class="admin-form__select" id="instrument-statut">
                <option value="disponible">Disponible</option>
                <option value="en_ligne">En ligne (boutique)</option>
                <option value="en_location">En location</option>
                <option value="vendu">Vendu</option>
                <option value="reserve">Réservé</option>
                <option value="prete">Prêté</option>
                <option value="en_fabrication">En fabrication</option>
              </select>
            </div>
          </div>
          
          <!-- Layout -->
          <div class="admin-form__group">
            <label class="admin-form__label">Layout (notes)</label>
            <input type="text" class="admin-form__input" id="instrument-layout" placeholder="D3 A3 Bb3 C4 D4 E4 F4 G4 A4">
            <div class="admin-form__hint">Séparez les notes par des espaces</div>
          </div>
          
          <!-- Description -->
          <div class="admin-form__group">
            <label class="admin-form__label">Description</label>
            <textarea class="admin-form__textarea" id="instrument-description" rows="3" placeholder="Décrivez l'instrument, son caractère sonore, ses particularités..."></textarea>
          </div>
          
          <hr style="border: none; border-top: 1px solid var(--admin-border); margin: 1.5rem 0;">
          
          <!-- Médias -->
          <div class="admin-form__group">
            <label class="admin-form__label">Images</label>
            <div id="instrument-images-upload"></div>
            <div id="instrument-images-preview" class="upload-preview-grid" style="margin-top: 0.75rem;"></div>
            <input type="hidden" id="instrument-images-data">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.85rem; color: var(--admin-text-muted); cursor: pointer;">
              <input type="checkbox" id="instrument-compress" style="width: 16px; height: 16px;">
              Compresser en WebP (réduit ~70% la taille)
            </label>
            <div style="margin-top: 0.75rem;">
              <details>
                <summary style="cursor: pointer; font-size: 0.8rem; color: var(--admin-text-muted);">Ou entrer des URLs manuellement</summary>
                <textarea class="admin-form__textarea" id="instrument-images-urls" rows="2" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg" style="margin-top: 0.5rem;"></textarea>
              </details>
            </div>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Vidéo</label>
            <div id="instrument-video-upload"></div>
            <div id="instrument-video-preview" style="margin-top: 0.75rem;"></div>
            <input type="hidden" id="instrument-video-data">
            <div style="margin-top: 0.75rem;">
              <details>
                <summary style="cursor: pointer; font-size: 0.8rem; color: var(--admin-text-muted);">Ou entrer une URL manuellement</summary>
                <input type="text" class="admin-form__input" id="instrument-video-url" placeholder="https://youtube.com/watch?v=... ou URL directe" style="margin-top: 0.5rem;">
              </details>
            </div>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Lien Handpaner</label>
            <input type="url" class="admin-form__input" id="instrument-handpaner" placeholder="https://handpaner.com/#D/-A-Bb-C-D-E-F-G-A-C_" oninput="AdminUI.parseHandpanerUrl()">
            <div class="admin-form__hint">Coller le lien pour remplir automatiquement les notes</div>
          </div>
          
          <!-- Commentaires internes -->
          <div class="admin-form__group">
            <label class="admin-form__label">Commentaires internes</label>
            <textarea class="admin-form__textarea" id="instrument-commentaires" rows="2" placeholder="Notes privées, historique..."></textarea>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('instrument')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveInstrument()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="admin-modal-overlay admin-modal--large" id="modal-location"><div class="admin-modal"><div class="admin-modal__header"><h3 class="admin-modal__title" id="modal-location-title">Nouvelle location</h3><button class="admin-modal__close" onclick="AdminUI.closeModal('location')">✕</button></div><div class="admin-modal__body"><form id="form-location"><input type="hidden" id="location-id"><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Client *</label><div class="searchable-select-container"><input type="text" class="admin-form__input searchable-input" id="location-client-search" placeholder="Rechercher..." autocomplete="off"><input type="hidden" id="location-client-id"><div class="searchable-dropdown" id="location-client-dropdown"></div></div></div><div class="admin-form__group"><label class="admin-form__label">Instrument *</label><div class="searchable-select-container"><input type="text" class="admin-form__input searchable-input" id="location-instrument-search" placeholder="Rechercher..." autocomplete="off"><input type="hidden" id="location-instrument-id"><div class="searchable-dropdown" id="location-instrument-dropdown"></div></div></div></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Date début *</label><input type="date" class="admin-form__input" id="location-date-debut" required></div><div class="admin-form__group"><label class="admin-form__label">Mode</label><select class="admin-form__select" id="location-mode"><option value="local">Local (chèque)</option><option value="distance">Distance (Swikly)</option></select></div></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Loyer (€)</label><input type="number" class="admin-form__input" id="location-loyer" value="50" min="0"></div><div class="admin-form__group"><label class="admin-form__label">Caution (€)</label><input type="number" class="admin-form__input" id="location-caution" value="1150" min="0"></div></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Caution statut</label><select class="admin-form__select" id="location-caution-statut"><option value="en_attente">En attente</option><option value="recue">Reçue</option><option value="restituee">Restituée</option></select></div><div class="admin-form__group"><label class="admin-form__label">Statut</label><select class="admin-form__select" id="location-statut"><option value="en_cours">En cours</option><option value="terminee">Terminée</option></select></div></div><div class="admin-form__group"><label class="admin-form__label">Notes</label><textarea class="admin-form__textarea" id="location-notes" rows="2"></textarea></div></form></div><div class="admin-modal__footer"><button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('location')">Annuler</button><button class="admin-btn admin-btn--primary" onclick="AdminUI.saveLocation()">Enregistrer</button></div></div></div>

  <div class="admin-modal-overlay admin-modal--large" id="modal-commande"><div class="admin-modal"><div class="admin-modal__header"><h3 class="admin-modal__title" id="modal-commande-title">Nouvelle commande</h3><button class="admin-modal__close" onclick="AdminUI.closeModal('commande')">✕</button></div><div class="admin-modal__body"><form id="form-commande"><input type="hidden" id="commande-id"><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Client *</label><div class="searchable-select-container"><input type="text" class="admin-form__input searchable-input" id="commande-client-search" placeholder="Rechercher..." autocomplete="off"><input type="hidden" id="commande-client-id"><div class="searchable-dropdown" id="commande-client-dropdown"></div></div></div><div class="admin-form__group"><label class="admin-form__label">Date</label><input type="date" class="admin-form__input" id="commande-date"></div></div><div class="admin-form__group"><label class="admin-form__label">Description</label><textarea class="admin-form__textarea" id="commande-description" rows="2"></textarea></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Montant (€)</label><input type="number" class="admin-form__input" id="commande-montant" min="0" step="5"></div><div class="admin-form__group"><label class="admin-form__label">Acompte (€)</label><input type="number" class="admin-form__input" id="commande-acompte" min="0" value="0"></div></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Paiement</label><select class="admin-form__select" id="commande-paiement-statut"><option value="en_attente">En attente</option><option value="partiel">Partiel</option><option value="paye">Payé</option></select></div><div class="admin-form__group"><label class="admin-form__label">Statut</label><select class="admin-form__select" id="commande-statut"><option value="en_attente">En attente</option><option value="en_fabrication">En fabrication</option><option value="accordage">Accordage</option><option value="pret">Prêt</option><option value="expedie">Expédié</option><option value="livre">Livré</option><option value="annule">Annulé</option></select></div></div><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">N° suivi colis</label><input type="text" class="admin-form__input" id="commande-tracking" placeholder="Numéro de suivi"></div><div class="admin-form__group"><label class="admin-form__label">Livraison estimée</label><input type="text" class="admin-form__input" id="commande-delivery" placeholder="ex: 3-5 jours ouvrés"></div></div><div class="admin-form__group"><label class="admin-form__label">Notes</label><textarea class="admin-form__textarea" id="commande-notes" rows="2"></textarea></div></form></div><div class="admin-modal__footer"><button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('commande')">Annuler</button><button class="admin-btn admin-btn--primary" onclick="AdminUI.saveCommande()">Enregistrer</button></div></div></div>

  <div class="admin-modal-overlay admin-modal--large" id="modal-facture"><div class="admin-modal"><div class="admin-modal__header"><h3 class="admin-modal__title" id="modal-facture-title">Nouvelle facture</h3><button class="admin-modal__close" onclick="AdminUI.closeModal('facture')">✕</button></div><div class="admin-modal__body"><form id="form-facture"><input type="hidden" id="facture-id"><div class="form-row"><div class="admin-form__group"><label class="admin-form__label">Client *</label><div class="searchable-select-container"><input type="text" class="admin-form__input searchable-input" id="facture-client-search" placeholder="Rechercher..." autocomplete="off"><input type="hidden" id="facture-client-id"><div class="searchable-dropdown" id="facture-client-dropdown"></div></div></div><div class="admin-form__group"><label class="admin-form__label">Date</label><input type="date" class="admin-form__input" id="facture-date"></div><div class="admin-form__group"><label class="admin-form__label">Type</label><select class="admin-form__select" id="facture-type"><option value="vente">Vente</option><option value="acompte">Acompte</option><option value="solde">Solde</option><option value="location">Location</option><option value="prestation">Prestation</option><option value="avoir">Avoir</option></select></div></div><div class="admin-form__group"><label class="admin-form__label">Lignes</label><div class="facture-lignes" id="facture-lignes"></div><div style="margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;"><div class="searchable-select-container" style="flex:1; min-width:200px;"><input type="text" class="admin-form__input searchable-input" id="facture-instrument-search" placeholder="Ajouter un instrument..." autocomplete="off"><div class="searchable-dropdown" id="facture-instrument-dropdown"></div></div><button type="button" class="admin-btn admin-btn--secondary admin-btn--sm" onclick="AdminUI.addFactureLigne()">+ Ligne libre</button></div></div><div class="facture-totaux"><div class="facture-total-row"><span>Total HT</span><span id="facture-total-ht">0 €</span></div><div class="facture-total-row facture-total-row--final"><span>Total TTC</span><span id="facture-total-ttc">0 €</span></div></div><div class="form-row" style="margin-top:1rem;"><div class="admin-form__group"><label class="admin-form__label">Paiement</label><select class="admin-form__select" id="facture-paiement-statut"><option value="en_attente">En attente</option><option value="partiel">Partiel</option><option value="paye">Payé</option></select></div><div class="admin-form__group"><label class="admin-form__label">Échéance</label><input type="date" class="admin-form__input" id="facture-echeance"></div></div><div class="admin-form__group"><label class="admin-form__label">Notes</label><textarea class="admin-form__textarea" id="facture-notes" rows="2"></textarea></div></form></div><div class="admin-modal__footer"><button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('facture')">Annuler</button><button class="admin-btn admin-btn--primary" onclick="AdminUI.saveFacture()">Enregistrer</button></div></div></div>

  <!-- Modal Accessoire -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-accessoire">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-accessoire-title">Nouvel accessoire</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('accessoire')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-accessoire">
          <input type="hidden" id="accessoire-id">
          
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Nom *</label>
              <input type="text" class="admin-form__input" id="accessoire-nom" required placeholder="Housse rigide Evatek">
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Catégorie *</label>
              <select class="admin-form__select" id="accessoire-categorie">
                <option value="housse">Housse</option>
                <option value="huile">Huile d'entretien</option>
                <option value="support">Support</option>
                <option value="accessoire">Autre accessoire</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Prix (€) *</label>
              <input type="number" class="admin-form__input" id="accessoire-prix" min="0" step="0.01" required>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Stock</label>
              <input type="number" class="admin-form__input" id="accessoire-stock" min="-1" value="-1">
              <div class="admin-form__hint">-1 = illimité (toujours disponible)</div>
            </div>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Description</label>
            <textarea class="admin-form__textarea" id="accessoire-description" rows="3" placeholder="Description de l'accessoire..."></textarea>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Image</label>
            <div id="accessoire-image-upload"></div>
            <div id="accessoire-image-preview" style="margin-top: 0.75rem;"></div>
            <input type="hidden" id="accessoire-image-data">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.85rem; color: var(--admin-text-muted); cursor: pointer;">
              <input type="checkbox" id="accessoire-compress" style="width: 16px; height: 16px;">
              Compresser en WebP
            </label>
            <div style="margin-top: 0.5rem;">
              <details>
                <summary style="cursor: pointer; font-size: 0.8rem; color: var(--admin-text-muted);">Ou entrer une URL manuellement</summary>
                <input type="text" class="admin-form__input" id="accessoire-image-url" placeholder="https://..." style="margin-top: 0.5rem;">
              </details>
            </div>
          </div>
          
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Statut</label>
              <select class="admin-form__select" id="accessoire-statut">
                <option value="actif">Actif (visible)</option>
                <option value="masque">Masqué</option>
              </select>
            </div>
          </div>

          <!-- Options Configurateur -->
          <div style="background: var(--admin-surface-hover); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.75rem;">
              <input type="checkbox" id="accessoire-visible-config" style="width: 18px; height: 18px;">
              <span style="font-weight: 500;">Proposer dans le configurateur</span>
            </label>

            <div id="accessoire-config-options" style="display: none; padding-left: 1.5rem; border-left: 2px solid var(--admin-border);">
              <label class="admin-form__label" style="margin-bottom: 0.5rem;">Tailles compatibles</label>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                  <input type="checkbox" id="accessoire-taille-45" style="width: 16px; height: 16px;">
                  <span>45 cm</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                  <input type="checkbox" id="accessoire-taille-50" style="width: 16px; height: 16px;">
                  <span>50 cm</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                  <input type="checkbox" id="accessoire-taille-53" style="width: 16px; height: 16px;">
                  <span>53 cm</span>
                </label>
              </div>
              <div class="admin-form__hint" style="margin-top: 0.5rem;">Sélectionnez les tailles d'instruments avec lesquelles cet accessoire est compatible</div>
            </div>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('accessoire')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveAccessoire()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Matériau -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-materiau">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-materiau-title">Nouveau matériau</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('materiau')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-materiau">
          <input type="hidden" id="materiau-id">

          <div class="form-row">
            <div class="admin-form__group" style="max-width: 100px;">
              <label class="admin-form__label">Code *</label>
              <input type="text" class="admin-form__input" id="materiau-code" required placeholder="NS" maxlength="4" style="text-transform: uppercase;">
              <div class="admin-form__hint">2-4 caractères</div>
            </div>
            <div class="admin-form__group" style="flex: 1;">
              <label class="admin-form__label">Nom complet *</label>
              <input type="text" class="admin-form__input" id="materiau-nom" required placeholder="Acier Nitruré">
            </div>
          </div>

          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Nom court</label>
              <input type="text" class="admin-form__input" id="materiau-nom-court" placeholder="Nitrure">
              <div class="admin-form__hint">Affiché dans les specs</div>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Malus prix (%)</label>
              <input type="number" class="admin-form__input" id="materiau-prix-malus" min="0" max="100" value="0" step="1">
              <div class="admin-form__hint">0 = pas de surcoût</div>
            </div>
          </div>

          <div class="admin-form__group">
            <label class="admin-form__label">Description</label>
            <textarea class="admin-form__textarea" id="materiau-description" rows="2" placeholder="Description du matériau..."></textarea>
          </div>

          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Couleur (hex)</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="color" id="materiau-couleur-picker" value="#C9A227" style="width: 40px; height: 32px; padding: 0; border: 1px solid var(--admin-border); border-radius: 4px; cursor: pointer;">
                <input type="text" class="admin-form__input" id="materiau-couleur" placeholder="#C9A227" style="flex: 1;">
              </div>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Ordre d'affichage</label>
              <input type="number" class="admin-form__input" id="materiau-ordre" min="0" value="1">
            </div>
          </div>

          <div class="form-row" style="margin-top: 1rem;">
            <div class="admin-form__group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="materiau-disponible" checked style="width: 18px; height: 18px;">
                <span>Disponible à la vente</span>
              </label>
            </div>
            <div class="admin-form__group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="materiau-visible-config" checked style="width: 18px; height: 18px;">
                <span>Visible dans le configurateur</span>
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('materiau')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveMateriau()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Gamme -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-gamme">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-gamme-title">Nouvelle gamme</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('gamme')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-gamme">
          <input type="hidden" id="gamme-id">
          <div class="form-row">
            <div class="admin-form__group" style="max-width: 140px;">
              <label class="admin-form__label">Code *</label>
              <input type="text" class="admin-form__input" id="gamme-code" required placeholder="kurd" style="text-transform: lowercase;">
              <div class="admin-form__hint">Identifiant unique</div>
            </div>
            <div class="admin-form__group" style="flex: 1;">
              <label class="admin-form__label">Nom *</label>
              <input type="text" class="admin-form__input" id="gamme-nom" required placeholder="Kurd">
            </div>
          </div>
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Catégorie</label>
              <select class="admin-form__select" id="gamme-categorie">
                <option value="debutant">Débutant</option>
                <option value="mineur">Mineur</option>
                <option value="majeur">Majeur</option>
                <option value="modal">Modal</option>
                <option value="oriental">Oriental</option>
                <option value="pentatonique">Pentatonique</option>
                <option value="autre">Autre</option>
              </select>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Mode musical</label>
              <select class="admin-form__select" id="gamme-mode">
                <option value="aeolian">Éolien (mineur naturel)</option>
                <option value="dorian">Dorien</option>
                <option value="phrygian">Phrygien</option>
                <option value="phrygian_dominant">Phrygien dominant</option>
                <option value="ionian">Ionien (majeur)</option>
                <option value="mixolydian">Mixolydien</option>
                <option value="lydian">Lydien</option>
                <option value="locrian">Locrien</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Tonalité de base</label>
              <input type="text" class="admin-form__input" id="gamme-baseroot" placeholder="D" maxlength="2">
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Octave de base</label>
              <input type="number" class="admin-form__input" id="gamme-baseoctave" min="2" max="5" value="3">
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Ordre</label>
              <input type="number" class="admin-form__input" id="gamme-ordre" min="0" value="1">
            </div>
          </div>
          <div class="admin-form__group">
            <label class="admin-form__label">Description</label>
            <textarea class="admin-form__textarea" id="gamme-description" rows="2" placeholder="Description de la gamme..."></textarea>
          </div>
          <div class="admin-form__group">
            <label class="admin-form__label">Ambiance</label>
            <input type="text" class="admin-form__input" id="gamme-mood" placeholder="Ex: Mélancolique, introspectif">
          </div>
          <div class="form-row" style="margin-top: 1rem;">
            <div class="admin-form__group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="gamme-disponible" checked style="width: 18px; height: 18px;">
                <span>Disponible</span>
              </label>
            </div>
            <div class="admin-form__group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="gamme-visible-config" style="width: 18px; height: 18px;">
                <span>Visible dans le configurateur</span>
              </label>
              <div class="admin-form__hint">Nécessite des patterns de layout dans scales-data.js</div>
            </div>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('gamme')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveGamme()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Taille -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-taille">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-taille-title">Nouvelle taille</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('taille')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-taille">
          <input type="hidden" id="taille-id">
          <div class="form-row">
            <div class="admin-form__group" style="max-width: 100px;">
              <label class="admin-form__label">Code *</label>
              <input type="text" class="admin-form__input" id="taille-code" required placeholder="53">
              <div class="admin-form__hint">Ex: 45, 50, 53</div>
            </div>
            <div class="admin-form__group" style="flex: 1;">
              <label class="admin-form__label">Label</label>
              <input type="text" class="admin-form__input" id="taille-label" placeholder="53 cm">
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Malus prix (€)</label>
              <input type="number" class="admin-form__input" id="taille-prix-malus" min="0" value="0" step="5">
            </div>
          </div>
          <div class="admin-form__group">
            <label class="admin-form__label">Description</label>
            <input type="text" class="admin-form__input" id="taille-description" placeholder="Standard — meilleure résonance">
          </div>
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Ordre</label>
              <input type="number" class="admin-form__input" id="taille-ordre" min="0" value="1">
            </div>
            <div class="admin-form__group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 1.5rem;">
                <input type="checkbox" id="taille-disponible" checked style="width: 18px; height: 18px;">
                <span>Disponible</span>
              </label>
            </div>
            <div class="admin-form__group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 1.5rem;">
                <input type="checkbox" id="taille-visible-config" checked style="width: 18px; height: 18px;">
                <span>Visible configurateur</span>
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('taille')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveTaille()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Professeur -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-professeur">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-professeur-title">Modifier le professeur</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('professeur')">✕</button>
      </div>
      <div class="admin-modal__body">
        <div id="edit-teacher-form-container" style="background:#fff; color:#333; padding: 1rem; border-radius: 8px;">
          <!-- Formulaire généré par TeacherForm -->
        </div>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('professeur')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveTeacher()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Média (Galerie) -->
  <div class="admin-modal-overlay admin-modal--medium" id="modal-media">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-media-title">Ajouter un média</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('media')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-media">
          <input type="hidden" id="media-id">
          
          <div class="admin-form__group">
            <label class="admin-form__label">Titre *</label>
            <input type="text" class="admin-form__input" id="media-titre" required placeholder="Ma création">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Description</label>
            <textarea class="admin-form__textarea" id="media-description" rows="2" placeholder="Description du média..."></textarea>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Image *</label>
            <div id="media-image-upload"></div>
            <div id="media-image-preview" style="margin-top: 0.75rem;"></div>
            <input type="hidden" id="media-image-data">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.85rem; color: var(--admin-text-muted); cursor: pointer;">
              <input type="checkbox" id="media-compress" style="width: 16px; height: 16px;">
              Compresser en WebP
            </label>
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer; font-size: 0.8rem; color: var(--admin-text-muted);">Ou entrer une URL</summary>
              <input type="text" class="admin-form__input" id="media-image-url" placeholder="https://..." style="margin-top: 0.5rem;">
            </details>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Vidéo (optionnel)</label>
            <div id="media-video-upload"></div>
            <div id="media-video-preview" style="margin-top: 0.75rem;"></div>
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer; font-size: 0.8rem; color: var(--admin-text-muted);">Ou entrer une URL YouTube/Vimeo</summary>
              <input type="text" class="admin-form__input" id="media-video-url" placeholder="https://youtube.com/..." style="margin-top: 0.5rem;">
            </details>
          </div>
          
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Instrument lié</label>
              <input type="text" class="admin-form__input" id="media-instrument" placeholder="D Kurd 9 notes">
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Date</label>
              <input type="date" class="admin-form__input" id="media-date">
            </div>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('media')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveMedia()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Article (Blog) -->
  <div class="admin-modal-overlay admin-modal--large" id="modal-article">
    <div class="admin-modal">
      <div class="admin-modal__header">
        <h3 class="admin-modal__title" id="modal-article-title">Nouvel article</h3>
        <button class="admin-modal__close" onclick="AdminUI.closeModal('article')">✕</button>
      </div>
      <div class="admin-modal__body">
        <form id="form-article">
          <input type="hidden" id="article-id">
          
          <div class="admin-form__group">
            <label class="admin-form__label">Titre *</label>
            <input type="text" class="admin-form__input" id="article-titre" required placeholder="Titre de l'article">
          </div>
          
          <div class="form-row">
            <div class="admin-form__group">
              <label class="admin-form__label">Catégorie</label>
              <select class="admin-form__select" id="article-categorie">
                <option value="actualite">Actualité</option>
                <option value="tutoriel">Tutoriel</option>
                <option value="fabrication">Fabrication</option>
                <option value="interview">Interview</option>
                <option value="evenement">Événement</option>
              </select>
            </div>
            <div class="admin-form__group">
              <label class="admin-form__label">Date de publication</label>
              <input type="date" class="admin-form__input" id="article-date">
            </div>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Image de couverture</label>
            <div id="article-image-upload"></div>
            <div id="article-image-preview" style="margin-top: 0.75rem;"></div>
            <input type="hidden" id="article-image-data">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.85rem; color: var(--admin-text-muted); cursor: pointer;">
              <input type="checkbox" id="article-compress" style="width: 16px; height: 16px;">
              Compresser en WebP
            </label>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Résumé</label>
            <textarea class="admin-form__textarea" id="article-resume" rows="2" placeholder="Résumé affiché dans la liste..."></textarea>
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Contenu *</label>
            <div id="article-editor" style="height: 300px; background: #fff; border: 1px solid var(--admin-border); border-radius: 8px;"></div>
            <input type="hidden" id="article-contenu">
          </div>
          
          <div class="admin-form__group">
            <label class="admin-form__label">Statut</label>
            <select class="admin-form__select" id="article-statut">
              <option value="brouillon">Brouillon</option>
              <option value="publie">Publié</option>
            </select>
          </div>
        </form>
      </div>
      <div class="admin-modal__footer">
        <button class="admin-btn admin-btn--secondary" onclick="AdminUI.closeModal('article')">Annuler</button>
        <button class="admin-btn admin-btn--primary" onclick="AdminUI.saveArticle()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div id="contact-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">Contact</h3>
        <button class="modal__close" onclick="closeContactModal()" aria-label="Fermer">&times;</button>
      </div>
      <div class="modal__body">
        <form id="contact-form" onsubmit="submitContactForm(event)">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="contact-firstname">Prénom *</label>
              <input type="text" id="contact-firstname" name="firstname" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="contact-lastname">Nom *</label>
              <input type="text" id="contact-lastname" name="lastname" class="form-input" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="contact-email">Email *</label>
            <input type="email" id="contact-email" name="email" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="contact-phone">Téléphone</label>
            <input type="tel" id="contact-phone" name="phone" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label" for="contact-message">Votre message *</label>
            <textarea id="contact-message" name="message" class="form-textarea" rows="4" required></textarea>
          </div>
          <button type="submit" class="btn btn--primary btn--full">Envoyer</button>
        </form>
        <p class="text-sm text-muted text-center" style="margin-top: var(--space-md);">
          Ou directement : <a href="mailto:contact@mistralpans.fr">contact@mistralpans.fr</a>
        </p>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="js/vendor/chart.umd.js" defer></script>
  <!-- Cookie Consent -->
  <script src="js/core/cookie-consent.js"></script>
  <!-- Configuration Supabase (copier config.example.js vers config.js) -->
  <script src="js/core/config.js"></script>
  <!-- Supabase -->
  <script src="js/vendor/supabase.js"></script>
  <script src="js/services/supabase-client.js"></script>
  <script src="js/services/supabase-auth.js"></script>
  <script src="js/admin/admin-core.js"></script>
  <script src="js/admin/gestion.js" defer></script>
  <script src="js/admin/gestion-pdf.js" defer></script>
  <script src="js/admin/gestion-boutique.js" defer></script>
  <script src="js/features/mistral-stats.js" defer></script>
  <script src="js/features/upload.js" defer></script>
  <script src="js/features/teacher-form.js" defer></script>
  <script src="js/vendor/quill.min.js" defer></script>
  <script src="js/data/materiaux-data.js" defer></script>
  <script src="js/data/gammes-data.js" defer></script>
  <script src="js/data/tailles-data.js" defer></script>
  <!-- Admin UI Modulaire -->
  <script src="js/admin/admin-ui-core.js" defer></script>
  <script src="js/admin/admin-ui-gestion.js" defer></script>
  <script src="js/admin/admin-ui-boutique.js" defer></script>
  <script src="js/admin/admin-ui-content.js" defer></script>
  <script src="js/admin/admin-ui-config.js" defer></script>
  <script src="js/admin/admin-ui-modals.js" defer></script>
  <script src="js/admin/admin-ui-compta.js" defer></script>
  <script src="js/admin/admin-vendor-check.js" defer></script>
  
  <script>
    (function() {
      'use strict';
      if (typeof MistralAdmin === 'undefined') { console.error('[Admin] MistralAdmin non chargé'); return; }
      
      const { Auth, Toast } = MistralAdmin;
      const HASH_MAP = { 'stock': 'boutique', 'teachers': 'professeurs', 'gallery': 'galerie', 'stats': 'analytics' };
      
      const loginView = document.getElementById('login-view');
      const adminView = document.getElementById('admin-view');
      const loginForm = document.getElementById('login-form');
      const loginError = document.getElementById('login-error');
      
      async function updateView() {
        // Verifier la session Supabase (async, source de verite)
        let loggedIn = false;
        if (typeof MistralAuth !== 'undefined') {
          loggedIn = await MistralAuth.isLoggedIn();
        }
        if (loggedIn) {
          loginView.style.display = 'none';
          adminView.style.display = 'block';
          initAdmin();
        } else {
          loginView.style.display = 'flex';
          adminView.style.display = 'none';
        }
      }
      
loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        // Vérifier que c'est un email valide
        if (!email.includes('@')) {
          loginError.textContent = 'Veuillez entrer une adresse email valide';
          loginError.classList.add('show');
          return;
        }

        // Vérifier que MistralAuth est disponible
        if (typeof MistralAuth === 'undefined') {
          loginError.textContent = 'Service d\'authentification non disponible';
          loginError.classList.add('show');
          return;
        }

        const btn = loginForm.querySelector('button[type="submit"]');
        btn.textContent = 'Connexion...';
        btn.disabled = true;

        const result = await MistralAuth.login(email, password);

        if (result.success) {
          loginError.classList.remove('show');
          updateView();
        } else {
          loginError.textContent = result.error || 'Identifiants incorrects';
          loginError.classList.add('show');
          document.getElementById('password').value = '';
        }

        btn.textContent = 'Connexion';
        btn.disabled = false;
      });
      
      document.getElementById('btn-logout').addEventListener('click', async function() {
        if (typeof MistralAuth !== 'undefined') {
          // MistralAuth.logout() redirige vers index.html
          await MistralAuth.logout();
        } else {
          Auth.logout();
          updateView();
        }
      });
      
      function initAdmin() {
        if (typeof AdminUI !== 'undefined') {
          AdminUI.init();
          let hash = window.location.hash.replace('#', '');
          if (HASH_MAP[hash]) hash = HASH_MAP[hash];
          if (hash) AdminUI.navigateTo(hash);
        }
        initSubtabs();
      }
      
      function initSubtabs() {
        document.querySelectorAll('[data-subtab]').forEach(function(btn) {
          btn.addEventListener('click', function() {
            const subtab = btn.dataset.subtab;
            const container = btn.closest('.gestion-section');
            btn.closest('.admin-tabs').querySelectorAll('[data-subtab]').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            if (container) {
              container.querySelectorAll('[id^="subtab-"]').forEach(function(el) { el.style.display = 'none'; });
              const subtabEl = container.querySelector('#subtab-' + subtab);
              if (subtabEl) subtabEl.style.display = 'block';
            }
          });
        });
      }
      
      window.syncFromGestion = function() {
        if (typeof GestionBoutique !== 'undefined') {
          const result = GestionBoutique.synchroniserTout();
          Toast.success(result.added > 0 ? result.added + ' instrument(s) publié(s)' : 'Aucun nouvel instrument');
        }
      };
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const openModal = document.querySelector('.admin-modal-overlay.open');
          if (openModal && typeof AdminUI !== 'undefined') AdminUI.closeModal(openModal.id.replace('modal-', ''));
          closeContactModal();
        }
      });
      
      document.querySelectorAll('.admin-modal-overlay').forEach(function(overlay) {
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay && typeof AdminUI !== 'undefined') AdminUI.closeModal(overlay.id.replace('modal-', ''));
        });
      });
      
      // Navigation mobile toggle
      const navToggle = document.querySelector('.nav__toggle');
      const navList = document.querySelector('.nav__list');
      if (navToggle && navList) {
        navToggle.addEventListener('click', function() {
          navList.classList.toggle('open');
          navToggle.setAttribute('aria-expanded', navList.classList.contains('open'));
        });
      }
      
      // Contact modal
      function openContactModal() {
        const modal = document.getElementById('contact-modal');
        if (modal) {
          modal.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
      }
      function closeContactModal() {
        const modal = document.getElementById('contact-modal');
        if (modal) {
          modal.classList.remove('open');
          document.body.style.overflow = '';
        }
      }
      function submitContactForm(e) {
        e.preventDefault();
        const f = e.target;
        const firstname = f.querySelector('[name="firstname"]').value.trim();
        const lastname = f.querySelector('[name="lastname"]').value.trim();
        const email = f.querySelector('[name="email"]').value.trim();
        const phone = f.querySelector('[name="phone"]').value.trim() || 'Non renseigné';
        const message = f.querySelector('[name="message"]').value.trim();
        const subject = '[Mistral Pans] Message de ' + firstname + ' ' + lastname;
        const body = 'Nom: ' + firstname + ' ' + lastname + '\nEmail: ' + email + '\nTéléphone: ' + phone + '\n\nMessage:\n' + message;
        window.location.href = 'mailto:contact@mistralpans.fr?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
        setTimeout(function() { closeContactModal(); f.reset(); }, 300);
      }
      document.querySelectorAll('[data-modal="contact"]').forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          openContactModal();
        });
      });
      // Fermer contact modal au clic overlay
      const contactOverlay = document.getElementById('contact-modal');
      if (contactOverlay) {
        contactOverlay.addEventListener('click', function(e) {
          if (e.target === contactOverlay) closeContactModal();
        });
      }
      
      // Attendre DOMContentLoaded pour que les scripts defer (AdminUI, etc.) soient charges
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateView);
      } else {
        updateView();
      }
    })();
  </script>
   <script src="js/services/supabase-sync.js"></script>

</body>
</html>
