<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Configurez votre handpan Mistral Pans. Choisissez la gamme, la tonalité, le nombre de notes et les options.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://mistralpans.fr/boutique.html">
  <meta property="og:title" content="Boutique Mistral Pans - Configurez votre handpan">
  <meta property="og:description" content="Configurez votre handpan sur mesure. Choisissez gamme, tonalité et options.">
  <meta property="og:image" content="https://mistralpans.fr/ressources/images/20230801_1622372.jpg">
  <meta property="og:locale" content="fr_FR">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Boutique Mistral Pans - Configurez votre handpan">
  <meta name="twitter:description" content="Configurez votre handpan sur mesure. Choisissez gamme, tonalité et options.">
  <meta name="twitter:image" content="https://mistralpans.fr/ressources/images/20230801_1622372.jpg">

  <title>Mistral Pans - Boutique | Configurez votre handpan</title>
  
  <!-- Fonts -->
  
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/boutique.css">
  
  <!-- Admin Styles -->
  <link rel="stylesheet" href="css/admin.css">

</head>
<body id="top" data-page="boutique">

  <!-- Header dynamique -->
  <div id="site-header"></div>

  <!-- ===== BOUTIQUE TABS (Mobile only) ===== -->
  <div class="boutique-tabs" id="boutique-tabs">
    <div class="boutique-tabs__inner">
      <button class="boutique-tab active" data-panel="config">
        Créer sur mesure
      </button>
      <button class="boutique-tab" data-panel="stock">
        En stock
        <span class="boutique-tab__badge">
          <span class="boutique-tab__badge-dot"></span>
          <span id="stock-count-tab">0</span>
        </span>
      </button>
    </div>
  </div>

  <!-- ===== BOUTIQUE WRAPPER ===== -->
  <div class="boutique-wrapper" id="boutique-wrapper">
    
    <!-- PANEL 1: CONFIGURATOR -->
    <div class="boutique-panel boutique-panel--config" id="panel-config">


  <!-- ===== CONFIGURATOR ===== -->
  <main id="main-content" class="configurator">
    
    <!-- LEFT: Player Visual -->
    <section class="config-player">
      <div class="player-container">
        <div class="player-info">
          <h1 class="player-info__name" id="display-name">D Kurd</h1>
          <p class="player-info__notes" id="display-notes">D3 • A3 • Bb3 • C4 • D4 • E4 • F4 • G4 • A4</p>
          <p class="player-info__mood" id="display-mood">9 notes</p>
        </div>
        
        <div class="player-visual" id="player-visual">
          <!-- SVG generated by JS -->
        </div>
        
        <div class="player-legend" id="player-legend">
          <span class="legend-item"><span class="legend-dot legend-dot--tonal"></span> Tonales</span>
        </div>
        
        <div class="player-controls">
          <button class="btn-play" id="btn-play">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="5,3 19,12 5,21"/>
            </svg>
            <span>Écouter</span>
          </button>
        </div>
      </div>
    </section>
    
    <!-- RIGHT: Options -->
    <section class="config-options">
      <div class="config-options-inner">
        <h2 class="config-title">Configurez votre instrument</h2>
        <p class="config-subtitle">Personnalisez selon vos préférences</p>
        
        <!-- Gamme -->
        <div class="option-group">
          <label class="option-label">Gamme</label>
          <div class="option-chips" id="chips-scale">
            <button class="chip active" data-value="kurd">Kurd</button>
            <button class="chip" data-value="amara">Amara</button>
            <button class="chip" data-value="lowpygmy">Low Pygmy</button>
            <button class="chip" data-value="hijaz">Hijaz</button>
            <button class="chip" data-value="myxolydian">Myxolydian</button>
            <button class="chip" data-value="equinox">Equinox</button>
          </div>
        </div>

        <!-- Matériau -->
        <div class="option-group">
          <label class="option-label">Matériau</label>
          <div class="option-cards option-cards--3" id="cards-material">
            <!-- Populated dynamically by JS -->
          </div>
        </div>

        <!-- Nombre de notes -->
        <div class="option-group">
          <label class="option-label">Nombre de notes</label>
          <div class="notes-counter">
            <button class="counter-btn" id="notes-minus" aria-label="Moins">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <span class="counter-value" id="notes-value">9</span>
            <button class="counter-btn" id="notes-plus" aria-label="Plus">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
          <p class="notes-hint" id="notes-hint"></p>
        </div>
        
        <!-- Plus d'options -->
        <div class="options-advanced">
          <button class="options-toggle" id="toggle-advanced">
            <span>Plus d'options</span>
            <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          <div class="options-advanced-content" id="advanced-content">
            
            <!-- Tonalité -->
            <div class="option-group">
              <label class="option-label">Tonalité <span class="option-value" id="label-tonality">D3</span></label>
              <div class="option-chips" id="chips-tonality">
                <button class="chip" data-value="F2">F2</button>
                <button class="chip" data-value="F#2">F#2</button>
                <button class="chip" data-value="G2">G2</button>
                <button class="chip" data-value="G#2">G#2</button>
                <button class="chip" data-value="A2">A2</button>
                <button class="chip" data-value="A#2">A#2</button>
                <button class="chip" data-value="B2">B2</button>
                <button class="chip" data-value="C3">C3</button>
                <button class="chip" data-value="C#3">C#3</button>
                <button class="chip active" data-value="D3">D3</button>
                <button class="chip" data-value="D#3">D#3</button>
                <button class="chip" data-value="E3">E3</button>
                <button class="chip" data-value="F3">F3</button>
                <button class="chip" data-value="F#3">F#3</button>
                <button class="chip" data-value="G3">G3</button>
              </div>
            </div>
            
            <!-- Accordage -->
            <div class="option-group">
              <label class="option-label">Accordage</label>
              <div class="option-cards option-cards--2" id="cards-tuning">
                <div class="radio-card active" data-value="440">
                  <div class="radio-card__value">440 Hz</div>
                  <div class="radio-card__label">Standard</div>
                </div>
                <div class="radio-card" data-value="432">
                  <div class="radio-card__value">432 Hz</div>
                  <div class="radio-card__label">Harmonique</div>
                </div>
              </div>
            </div>
            
            <!-- Taille -->
            <div class="option-group">
              <label class="option-label">Taille (diamètre)</label>
              <div class="option-cards" id="cards-size">
                <div class="radio-card" data-value="45">
                  <div class="radio-card__value">45 cm</div>
                  <div class="radio-card__label">Compact</div>
                  <div class="radio-card__price">+100 €</div>
                </div>
                <div class="radio-card" data-value="50">
                  <div class="radio-card__value">50 cm</div>
                  <div class="radio-card__label">Medium</div>
                  <div class="radio-card__price">+100 €</div>
                </div>
                <div class="radio-card active" data-value="53">
                  <div class="radio-card__value">53 cm</div>
                  <div class="radio-card__label">Standard</div>
                </div>
              </div>
            </div>
            
          </div>
        </div>

        <!-- Accessoires (Housse) -->
        <div class="option-group option-group--accessoires" id="accessoires-section" style="display: none;">
          <label class="option-label">Ajouter une housse</label>
          <div class="accessoires-list" id="accessoires-list">
            <!-- Populated dynamically by JS -->
          </div>
        </div>
      </div>

      <!-- FOOTER: Price & CTA -->
      <div class="config-footer">
        <div class="price-display">
          <div class="price-breakdown" id="price-breakdown" style="display: none;">
            <span class="price-line">Instrument: <span id="price-instrument">1 080 €</span></span>
            <span class="price-line" id="price-housse-line" style="display: none;">Housse: <span id="price-housse">0 €</span></span>
          </div>
          <div class="price-total">
            <span class="price-label">Prix total</span>
            <span class="price-value" id="total-price">1 080 €</span>
          </div>
        </div>

        <a href="commander.html" class="btn btn-primary" id="btn-order">
          Commander cet instrument
        </a>

        <p class="config-note">
          Besoin de conseils ? <a href="#" data-modal="contact">Contactez-moi</a>
        </p>
      </div>
      
    </section>
  </main>
      
    </div><!-- end panel-config -->
    
    <!-- PANEL 2: STOCK -->
    <div class="boutique-panel boutique-panel--stock" id="panel-stock">
    
      <!-- Navigation Band (at top of stock panel) -->
      <div class="boutique-nav-band" id="nav-band">
        <button class="boutique-nav-band__btn" id="nav-band-btn">
          <span id="nav-band-text">Instruments en stock</span>
          <span class="nav-band__badge" id="nav-band-badge">
            <span class="nav-band__badge-dot"></span>
            <span id="nav-band-count">0</span>
          </span>
          <svg class="nav-band__arrow nav-band__arrow--down" id="nav-arrow-down" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
          <svg class="nav-band__arrow nav-band__arrow--up" id="nav-arrow-up" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
            <polyline points="18 15 12 9 6 15"></polyline>
          </svg>
        </button>
      </div>
  
  <!-- ===== FLASH SALES SECTION ===== -->
  <section class="flash-section" id="flash-sales">
    <div class="flash-container">
      <div class="flash-header">
        <div>
          <h2 class="flash-title">
            Disponibles immédiatement
            <span class="flash-badge">
              <span class="flash-dot" style="width:6px;height:6px;animation:none;"></span>
              <span id="stock-count-section">2</span> en stock
            </span>
          </h2>
          <p class="flash-subtitle">Ces instruments sont prêts à partir. Chaque pièce est unique.</p>
        </div>
      </div>
      
      <div class="flash-cards" id="flash-cards-container">
        <!-- Cards will be loaded by JavaScript -->
      </div>
    </div>
  </section>
  
    </div><!-- end panel-stock -->
  </div><!-- end boutique-wrapper -->
  
  <!-- Dots indicator (Mobile only) -->
  <div class="boutique-dots" id="boutique-dots">
    <button class="boutique-dot active" data-panel="config" aria-label="Configurateur"></button>
    <button class="boutique-dot" data-panel="stock" aria-label="Stock"></button>
  </div>
  
  <!-- Footer dynamique -->
  <div id="site-footer"></div>

  <!-- Contact modal dynamique -->
  <div id="contact-modal-container"></div>

  <!-- ===== MODALE DÉTAIL ANNONCE ===== -->
  <div class="annonce-modal" id="annonce-modal">
    <div class="annonce-modal__overlay"></div>
    <div class="annonce-modal__content">
      <!-- Header -->
      <div class="annonce-modal__header">
        <h2 class="annonce-modal__title" id="modal-annonce-title">D Kurd</h2>
        <button class="annonce-modal__close" id="modal-annonce-close" aria-label="Fermer">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Body -->
      <div class="annonce-modal__body">
        <!-- Left: Gallery -->
        <div class="annonce-modal__gallery">
          <div class="annonce-gallery__main" id="modal-gallery-main">
            <img src="" alt="Photo principale" id="modal-main-image">
            <span class="annonce-gallery__no-image" id="modal-no-image" style="display:none;">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span>Aucune photo</span>
            </span>
            <button class="annonce-gallery__nav annonce-gallery__nav--prev" id="modal-gallery-prev" aria-label="Photo précédente">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button class="annonce-gallery__nav annonce-gallery__nav--next" id="modal-gallery-next" aria-label="Photo suivante">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
          <div class="annonce-gallery__thumbs" id="modal-gallery-thumbs">
            <!-- Thumbnails populated by JS -->
          </div>
        </div>

        <!-- Right: Details -->
        <div class="annonce-modal__details">
          <!-- Specs -->
          <div class="annonce-specs" id="modal-specs">
            <div class="annonce-spec">
              <span class="annonce-spec__label">Gamme</span>
              <span class="annonce-spec__value" id="modal-spec-gamme">—</span>
            </div>
            <div class="annonce-spec">
              <span class="annonce-spec__label">Notes</span>
              <span class="annonce-spec__value" id="modal-spec-notes">—</span>
            </div>
            <div class="annonce-spec">
              <span class="annonce-spec__label">Tonalité</span>
              <span class="annonce-spec__value" id="modal-spec-tonalite">—</span>
            </div>
            <div class="annonce-spec">
              <span class="annonce-spec__label">Accordage</span>
              <span class="annonce-spec__value" id="modal-spec-accordage">—</span>
            </div>
            <div class="annonce-spec">
              <span class="annonce-spec__label">Taille</span>
              <span class="annonce-spec__value" id="modal-spec-taille">—</span>
            </div>
            <div class="annonce-spec">
              <span class="annonce-spec__label">Matériau</span>
              <span class="annonce-spec__value" id="modal-spec-materiau">—</span>
            </div>
          </div>

          <!-- Notes layout -->
          <div class="annonce-notes-layout" id="modal-notes-layout">
            <span class="annonce-notes-layout__label">Disposition des notes</span>
            <span class="annonce-notes-layout__value" id="modal-notes-value">—</span>
          </div>

          <!-- Description -->
          <div class="annonce-description" id="modal-description-container" style="display:none;">
            <p id="modal-description"></p>
          </div>

          <!-- Video link -->
          <a href="#" class="annonce-video-link" id="modal-video-link" target="_blank" rel="noopener" style="display:none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Voir la vidéo
          </a>

          <!-- Handpaner link -->
          <a href="#" class="annonce-handpaner-link" id="modal-handpaner-link" target="_blank" rel="noopener" style="display:none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            Voir sur Handpaner
          </a>

          <!-- Options -->
          <div class="annonce-options">
            <!-- Housse -->
            <div class="annonce-option" id="modal-housse-container" style="display:none;">
              <label class="annonce-option__label" for="modal-housse-select">Ajouter une housse</label>
              <select class="annonce-option__select" id="modal-housse-select">
                <option value="">Sans housse</option>
                <!-- Options populated by JS -->
              </select>
            </div>

            <!-- Livraison -->
            <div class="annonce-option">
              <label class="annonce-option__checkbox">
                <input type="checkbox" id="modal-livraison-checkbox">
                <span class="annonce-option__checkmark"></span>
                <span>Livraison (+50€)</span>
              </label>
            </div>
          </div>

          <!-- Price -->
          <div class="annonce-price">
            <div class="annonce-price__breakdown" id="modal-price-breakdown">
              <div class="annonce-price__line">
                <span>Instrument</span>
                <span id="modal-price-instrument">0 €</span>
              </div>
              <div class="annonce-price__line" id="modal-price-housse-line" style="display:none;">
                <span>Housse</span>
                <span id="modal-price-housse">0 €</span>
              </div>
              <div class="annonce-price__line" id="modal-price-livraison-line" style="display:none;">
                <span>Livraison</span>
                <span>50 €</span>
              </div>
            </div>
            <div class="annonce-price__total">
              <span class="annonce-price__label">Prix total</span>
              <span class="annonce-price__value" id="modal-price-total">0 €</span>
            </div>
          </div>

          <!-- CTA -->
          <a href="commander.html" class="btn btn-primary annonce-cta" id="modal-order-btn">
            Commander cet instrument
          </a>

          <p class="annonce-contact-note">
            Des questions ? <a href="#" data-modal="contact">Contactez-moi</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scales data (unified source) -->
  <script src="js/scales-data.js"></script>

  <!-- Matériaux data (unified source) -->
  <script src="js/materiaux-data.js"></script>

  <!-- Module de faisabilité -->
  <script src="js/feasibility-module.js"></script>

  <script>
    // ===== SCALES DATA (from unified scales-data.js) =====
    const SCALES_DATA = MistralScales.SCALES_DATA;
    const NOTE_NAMES = MistralScales.NOTE_NAMES;
    const FLATS_TO_SHARPS = MistralScales.FLATS_TO_SHARPS;
    const SHARPS_TO_FLATS = MistralScales.SHARPS_TO_FLATS;
    const toDisplayNotation = MistralScales.toDisplayNotation;
    const shouldUseFlats = MistralScales.shouldUseFlats;
    const getTonalityChipNotation = MistralScales.getTonalityChipNotation;

    // Update tonality chips labels based on music theory rules
    // Each chip displays its correct notation according to the cycle of fifths:
    // - Eb, Ab, Bb always shown as flats (D#, G#, A# are theoretically impractical)
    // - Db shown as flat (easier than C# with 7 sharps)
    // - F#/Gb depends on scale preference
    function updateTonalityChipsLabels() {
      const scaleData = SCALES_DATA[state.scale];

      document.querySelectorAll('#chips-tonality .chip').forEach(chip => {
        const value = chip.dataset.value; // Always stored as sharps internally
        chip.textContent = getTonalityChipNotation(value, scaleData);
      });
    }

    // Base frequencies for octave 0
    const BASE_FREQ = 16.35; // C0
    
    // ===== STATE =====
    const state = {
      scale: 'kurd',
      notes: 9,
      tonality: 'D3',
      tuning: '440',
      size: '53',
      material: 'NS',  // Default material: Acier Nitruré
      housse: null     // Selected housse accessory (null = none)
    };
    
    // ===== PRICING =====
    const pricePerNote = 115;
    const priceOctave2Bonus = 50;  // +50€ par note en octave 2
    const priceBottomBonus = 25;   // +25€ si l'instrument a des bottoms
    const sizeMalus = { '53': 0, '50': 0.025, '45': 0.05 };  // +2.5% pour 50cm, +5% pour 45cm
    
    function calculatePrice(notes, size, feasibilityStatus, materialCode) {
      let price = 0;
      let hasBottom = false;

      notes.forEach(note => {
        price += pricePerNote;
        if (note.octave === 2) {
          price += priceOctave2Bonus;
        }
        if (note.type === 'bottom') {
          hasBottom = true;
        }
      });

      // Bonus bottom (une seule fois)
      if (hasBottom) {
        price += priceBottomBonus;
      }

      // Malus taille (en %)
      const sizeMultiplier = 1 + (sizeMalus[size] || 0);
      price = price * sizeMultiplier;

      // Malus matériau (en %)
      const materialMalus = typeof MistralMateriaux !== 'undefined'
        ? MistralMateriaux.getPrixMalus(materialCode)
        : 0;
      if (materialMalus > 0) {
        price = price * (1 + materialMalus / 100);
      }

      // Pourcentage selon difficulté
      if (feasibilityStatus === 'warning') {
        price = price * 1.05;
      } else if (feasibilityStatus === 'difficult') {
        price = price * 1.10;
      }

      // Arrondir à la tranche de 5€ inférieure
      return Math.floor(price / 5) * 5;
    }
    
    // ===== AUDIO (FLAC Samples) =====
    const audioCache = {};
    const AUDIO_PATH = 'ressources/audio/';
    
    // Convertir le nom de note interne vers le nom du fichier
    // Ex: "C#4" → "Cs4", "Bb3" → "As3" (Bb = A#)
    function noteToFileName(noteName) {
      // D'abord normaliser les bémols en dièses
      const flatToSharp = {
        'Db': 'Cs', 'Eb': 'Ds', 'Fb': 'E', 'Gb': 'Fs',
        'Ab': 'Gs', 'Bb': 'As', 'Cb': 'B'
      };
      
      let fileName = noteName;
      
      // Remplacer les bémols par leurs équivalents dièses
      for (const [flat, sharp] of Object.entries(flatToSharp)) {
        if (fileName.startsWith(flat)) {
          fileName = fileName.replace(flat, sharp);
          break;
        }
      }
      
      // Remplacer # par s pour le nom de fichier
      fileName = fileName.replace('#', 's');
      
      return fileName;
    }
    
    // Précharger un fichier audio
    async function preloadAudio(noteName) {
      const fileName = noteToFileName(noteName);
      if (audioCache[fileName]) return audioCache[fileName];
      
      try {
        const audio = new Audio(`${AUDIO_PATH}${fileName}.flac`);
        audio.preload = 'auto';
        audioCache[fileName] = audio;
        return audio;
      } catch (e) {
        console.warn(`Impossible de charger ${fileName}.flac`);
        return null;
      }
    }
    
    // Jouer une note
    function playNote(noteName) {
      const fileName = noteToFileName(noteName);
      
      // Vérifier si déjà en cache
      if (audioCache[fileName]) {
        const audio = audioCache[fileName].cloneNode();
        audio.volume = 0.7;
        audio.play().catch(e => console.warn('Erreur lecture audio:', e));
        return;
      }
      
      // Sinon charger et jouer
      const audio = new Audio(`${AUDIO_PATH}${fileName}.flac`);
      audio.volume = 0.7;
      audioCache[fileName] = audio;
      audio.play().catch(e => console.warn('Erreur lecture audio:', e));
    }
    
    // Précharger les notes de la gamme courante
    function preloadCurrentScale() {
      const notes = getCurrentNotes();
      notes.forEach(n => preloadAudio(`${n.note}${n.octave}`));
    }
    
    // Compatibilité avec l'ancien code (freq → note)
    // Garder getFrequency pour le tri des notes par hauteur
    function getFrequency(note, octave) {
      const noteIndex = NOTE_NAMES.indexOf(note);
      if (noteIndex === -1) return 0;
      const semitones = octave * 12 + noteIndex;
      let freq = BASE_FREQ * Math.pow(2, semitones / 12);
      if (state.tuning === '432') freq *= (432 / 440);
      return freq;
    }
    
    // ===== PARSE PATTERN =====
    function normalizeNote(noteStr) {
      for (const [flat, sharp] of Object.entries(FLATS_TO_SHARPS)) {
        if (noteStr.startsWith(flat)) {
          return noteStr.replace(flat, sharp);
        }
      }
      return noteStr;
    }
    
    function parseNote(noteStr) {
      noteStr = normalizeNote(noteStr);
      const match = noteStr.match(/^([A-G]#?)(\d)?$/);
      if (!match) return null;
      return { note: match[1], octave: match[2] ? parseInt(match[2]) : null };
    }
    
    function parsePattern(pattern, rootNote, rootOctave, transpose) {
      const notes = [];
      pattern = pattern.replace(/_$/, '').replace(/\s+/g, ' ').trim();
      
      const slashIndex = pattern.indexOf('/');
      if (slashIndex === -1) return notes;
      
      let notesPart = pattern.substring(slashIndex + 1).trim();
      
      const tokens = [];
      let current = '';
      let inParens = false;
      let inBrackets = false;
      
      for (let i = 0; i < notesPart.length; i++) {
        const char = notesPart[i];
        
        if (char === '(') {
          if (current.trim()) tokens.push(current.trim());
          current = '(';
          inParens = true;
        } else if (char === ')') {
          current += ')';
          tokens.push(current.trim());
          current = '';
          inParens = false;
        } else if (char === '[') {
          if (current.trim()) tokens.push(current.trim());
          current = '[';
          inBrackets = true;
        } else if (char === ']') {
          current += ']';
          tokens.push(current.trim());
          current = '';
          inBrackets = false;
        } else if ((char === '-' || char === ' ') && !inParens && !inBrackets) {
          if (current.trim()) tokens.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      if (current.trim()) tokens.push(current.trim());
      
      const filteredTokens = tokens.filter(t => t && t.length > 0);
      
      const dingNote = transposeNote(rootNote, rootOctave, transpose);
      notes.push({ 
        ...dingNote,
        type: 'ding',
        freq: getFrequency(dingNote.note, dingNote.octave)
      });
      
      const rootIndex = NOTE_NAMES.indexOf(rootNote);
      
      let tonalOctave = rootOctave;
      let lastTonalIndex = rootIndex;
      let isFirstTonal = true;
      let bottomOctave = rootOctave;
      
      filteredTokens.forEach(token => {
        let type = 'tonal';
        let noteStr = token;
        
        if (token.startsWith('(') && token.endsWith(')')) {
          type = 'bottom';
          noteStr = token.slice(1, -1);
        } else if (token.startsWith('[') && token.endsWith(']')) {
          type = 'mutant';
          noteStr = token.slice(1, -1);
        }
        
        const parsed = parseNote(noteStr);
        if (!parsed) return;
        
        let noteOctave = parsed.octave;
        const noteIndex = NOTE_NAMES.indexOf(parsed.note);
        
        if (noteOctave === null) {
          if (type === 'tonal' || type === 'mutant') {
            if (isFirstTonal) {
              isFirstTonal = false;
            } else {
              if (noteIndex <= lastTonalIndex) {
                tonalOctave++;
              }
            }
            noteOctave = tonalOctave;
            lastTonalIndex = noteIndex;
          } else {
            noteOctave = bottomOctave;
          }
        } else {
          if (type === 'tonal' || type === 'mutant') {
            tonalOctave = noteOctave;
            lastTonalIndex = noteIndex;
            isFirstTonal = false;
          } else {
            bottomOctave = noteOctave;
          }
        }
        
        const transposed = transposeNote(parsed.note, noteOctave, transpose);
        notes.push({
          ...transposed,
          type: type,
          freq: getFrequency(transposed.note, transposed.octave)
        });
      });
      
      return notes;
    }
    
    function transposeNote(note, octave, semitones) {
      const noteIndex = NOTE_NAMES.indexOf(note);
      const newIndex = noteIndex + semitones;
      const newOctave = octave + Math.floor(newIndex / 12);
      const newNote = NOTE_NAMES[((newIndex % 12) + 12) % 12];
      return { note: newNote, octave: newOctave };
    }
    
    function getTransposition() {
      const scaleData = SCALES_DATA[state.scale];
      const baseNote = scaleData.baseRoot;
      const baseOctave = scaleData.baseOctave;
      
      const targetMatch = state.tonality.match(/^([A-G]#?)(\d)$/);
      if (!targetMatch) return 0;
      
      const targetNote = targetMatch[1];
      const targetOctave = parseInt(targetMatch[2]);
      
      const baseIndex = NOTE_NAMES.indexOf(baseNote) + baseOctave * 12;
      const targetIndex = NOTE_NAMES.indexOf(targetNote) + targetOctave * 12;
      
      return targetIndex - baseIndex;
    }
    
    function getCurrentNotes() {
      const scaleData = SCALES_DATA[state.scale];
      const pattern = scaleData.patterns[state.notes];
      if (!pattern) return [];
      
      const transpose = getTransposition();
      return parsePattern(pattern, scaleData.baseRoot, scaleData.baseOctave, transpose);
    }
    
    // ===== RENDER PLAYER =====
    function renderPlayer() {
      const notes = getCurrentNotes();
      const scaleData = SCALES_DATA[state.scale];
      const useFlats = shouldUseFlats(state.tonality, scaleData);
      const size = 780;
      const center = size / 2;

      const ding = notes.find(n => n.type === 'ding');
      const tonals = notes.filter(n => n.type === 'tonal');
      const mutants = notes.filter(n => n.type === 'mutant');
      const bottoms = notes.filter(n => n.type === 'bottom');

      const shellRadius = size * 0.35;
      const tonalRadius = size * 0.26;
      const dingSize = size * 0.08;       // Larger ding (was 0.07)
      const noteSize = size * 0.055;       // Larger notes for better touch targets (was 0.045)
      const mutantRadius = size * 0.15;
      const mutantNoteSize = noteSize * 0.85;  // Slightly larger mutants (was 0.8)
      const bottomRadius = size * 0.46;
      const bottomNoteSize = noteSize * 0.9;   // Slightly larger bottoms (was 0.85)
      
      const margin = 100;
      const viewBoxX = -margin;
      const viewBoxY = -margin;
      const viewBoxW = size + margin * 2;
      const viewBoxH = size + margin * 2.2;
      
      let svg = `
        <svg viewBox="${viewBoxX} ${viewBoxY} ${viewBoxW} ${viewBoxH}" width="${size}" height="${size * 1.1}" style="overflow: visible;">
          <defs>
            <radialGradient id="shell-grad" cx="30%" cy="30%">
              <stop offset="0%" stop-color="#E8E8E8"/>
              <stop offset="70%" stop-color="#B8B8B8"/>
              <stop offset="100%" stop-color="#7A7A7A"/>
            </radialGradient>
          </defs>

          <circle cx="${center}" cy="${center}" r="${shellRadius}" fill="url(#shell-grad)"/>
          <circle cx="${center}" cy="${center}" r="${shellRadius - 2}" fill="none" stroke="#909090" stroke-width="1.5"/>
      `;

      if (ding) {
        const dingDisplay = toDisplayNotation(`${ding.note}${ding.octave}`, useFlats);
        svg += `
          <g class="note-group" data-note="${ding.note}${ding.octave}" data-freq="${ding.freq}">
            <circle cx="${center}" cy="${center}" r="${dingSize}" class="note-circle note-ding" stroke="#686868" stroke-width="1.5"/>
            <text x="${center}" y="${center}" text-anchor="middle" dominant-baseline="central" class="note-label" fill="#3A3A3A" font-size="16" font-weight="600" font-family="system-ui">${dingDisplay}</text>
          </g>
        `;
      }

      mutants.forEach((note, i) => {
        const pos = getMutantPosition(i, mutants.length, mutantRadius, center);
        const noteDisplay = toDisplayNotation(`${note.note}${note.octave}`, useFlats);
        svg += `
          <g class="note-group" data-note="${note.note}${note.octave}" data-freq="${note.freq}">
            <circle cx="${pos.x}" cy="${pos.y}" r="${mutantNoteSize}" class="note-circle note-mutant" stroke="#787878" stroke-width="1.5"/>
            <text x="${pos.x}" y="${pos.y}" text-anchor="middle" dominant-baseline="central" class="note-label" fill="#3A3A3A" font-size="13" font-weight="600" font-family="system-ui">${noteDisplay}</text>
          </g>
        `;
      });

      tonals.forEach((note, i) => {
        const pos = getTonalPosition(i, tonals.length, tonalRadius, center);
        const noteDisplay = toDisplayNotation(`${note.note}${note.octave}`, useFlats);
        svg += `
          <g class="note-group" data-note="${note.note}${note.octave}" data-freq="${note.freq}">
            <circle cx="${pos.x}" cy="${pos.y}" r="${noteSize}" class="note-circle note-tonal" stroke="#686868" stroke-width="1.5"/>
            <text x="${pos.x}" y="${pos.y}" text-anchor="middle" dominant-baseline="central" class="note-label" fill="#3A3A3A" font-size="14" font-weight="600" font-family="system-ui">${noteDisplay}</text>
          </g>
        `;
      });

      bottoms.forEach((note, i) => {
        const pos = getBottomPosition(i, bottoms.length, bottomRadius, center);
        const noteDisplay = toDisplayNotation(`${note.note}${note.octave}`, useFlats);
        svg += `
          <g class="note-group" data-note="${note.note}${note.octave}" data-freq="${note.freq}">
            <circle cx="${pos.x}" cy="${pos.y}" r="${bottomNoteSize}" class="note-circle note-bottom" stroke="#505050" stroke-width="1.5" stroke-dasharray="3 2"/>
            <text x="${pos.x}" y="${pos.y}" text-anchor="middle" dominant-baseline="central" class="note-label" fill="#E8E8E8" font-size="13" font-weight="600" font-family="system-ui">${noteDisplay}</text>
          </g>
        `;
      });
      
      svg += '</svg>';
      
      document.getElementById('player-visual').innerHTML = svg;
      
      let legendHTML = '<span class="legend-item"><span class="legend-dot legend-dot--tonal"></span> Tonales</span>';
      if (mutants.length > 0) {
        legendHTML += '<span class="legend-item"><span class="legend-dot legend-dot--mutant"></span> Mutants</span>';
      }
      if (bottoms.length > 0) {
        legendHTML += '<span class="legend-item"><span class="legend-dot legend-dot--bottom"></span> Bottoms</span>';
      }
      document.getElementById('player-legend').innerHTML = legendHTML;
      
      // Précharger les notes de la gamme
      preloadCurrentScale();
      
      document.querySelectorAll('.note-group').forEach(g => {
        g.addEventListener('click', () => {
          const noteName = g.dataset.note;
          if (noteName) playNote(noteName);
          g.classList.add('active');
          setTimeout(() => g.classList.remove('active'), 300);
        });
      });
    }
    
    function getTonalPosition(index, total, radius, center) {
      let angleDeg;
      const lastIndex = total - 1;
      const isEvenTotal = (total % 2 === 0);
      
      if (total === 1) {
        angleDeg = 270;
      } else if (total === 2) {
        angleDeg = index === 0 ? 250 : 290;
      } else if (index === lastIndex) {
        angleDeg = 90;
      } else if (isEvenTotal && index === 0) {
        angleDeg = 270;
      } else {
        let adjustedIndex, middleCount, isRight, sideIndex, notesPerSide;
        
        if (isEvenTotal) {
          adjustedIndex = index - 1;
          middleCount = total - 2;
          isRight = (adjustedIndex % 2 === 1);
          sideIndex = Math.floor(adjustedIndex / 2);
          notesPerSide = Math.ceil(middleCount / 2);
          
          if (isRight) {
            const step = notesPerSide > 1 ? 90 / (notesPerSide - 1) : 0;
            angleDeg = 315 + sideIndex * step;
            if (angleDeg >= 360) angleDeg -= 360;
          } else {
            const step = notesPerSide > 1 ? 90 / (notesPerSide - 1) : 0;
            angleDeg = 225 - sideIndex * step;
          }
        } else {
          isRight = (index % 2 === 0);
          sideIndex = Math.floor(index / 2);
          notesPerSide = Math.ceil((total - 1) / 2);
          
          if (isRight) {
            const range = 120;
            const step = notesPerSide > 1 ? range / (notesPerSide - 1) : 0;
            angleDeg = 290 + sideIndex * step;
            if (angleDeg >= 360) angleDeg -= 360;
          } else {
            const range = 120;
            const step = notesPerSide > 1 ? range / (notesPerSide - 1) : 0;
            angleDeg = 250 - sideIndex * step;
          }
        }
      }
      
      const angleRad = angleDeg * Math.PI / 180;
      const x = center + Math.cos(angleRad) * radius;
      const y = center - Math.sin(angleRad) * radius;
      
      return { x, y };
    }
    
    function getMutantPosition(index, total, radius, center) {
      if (total === 1) {
        return { x: center, y: center - radius };
      }
      
      const arcSpread = Math.min(120, 40 + (total - 1) * 30);
      const startAngle = 90 + arcSpread / 2;
      const step = arcSpread / (total - 1);
      const angleDeg = startAngle - (index * step);
      
      const angleRad = angleDeg * Math.PI / 180;
      const x = center + Math.cos(angleRad) * radius;
      const y = center - Math.sin(angleRad) * radius;
      
      return { x, y };
    }
    
    function getBottomPosition(index, total, radius, center) {
      if (total === 1) {
        return { x: center, y: center + radius };
      }
      
      const arcSpread = Math.min(140, 40 + (total - 1) * 25);
      const startAngle = 270 - arcSpread / 2;
      const step = arcSpread / (total - 1);
      const angleDeg = startAngle + (index * step);
      
      const angleRad = angleDeg * Math.PI / 180;
      const x = center + Math.cos(angleRad) * radius;
      const y = center - Math.sin(angleRad) * radius;
      
      return { x, y };
    }
    
    // ===== UPDATE DISPLAY =====
    function updateDisplay() {
      const scaleData = SCALES_DATA[state.scale];
      // Music theory rules: Eb/Ab/Bb/Db roots use flats, F# depends on scale, natural roots use scale preference
      const useFlats = shouldUseFlats(state.tonality, scaleData);
      const notes = getCurrentNotes();

      const rootMatch = state.tonality.match(/^([A-G]#?)(\d)$/);
      const rootNote = rootMatch ? rootMatch[1] : state.tonality;
      // Root display: convert to flat notation if needed (A# -> Bb, G# -> Ab, etc.)
      const rootDisplay = useFlats ? (SHARPS_TO_FLATS[rootNote] || rootNote) : rootNote;
      document.getElementById('display-name').textContent = `${rootDisplay} ${scaleData.name}`;
      document.getElementById('display-notes').textContent = notes.map(n => toDisplayNotation(`${n.note}${n.octave}`, useFlats)).join(' • ');
      document.getElementById('display-mood').textContent = `${state.notes} notes`;

      // Tonality label: stays as stored (sharps internally), displayed per context
      document.getElementById('label-tonality').textContent = toDisplayNotation(state.tonality, useFlats);

      document.getElementById('notes-value').textContent = state.notes;
      document.getElementById('notes-minus').disabled = state.notes <= 9;
      document.getElementById('notes-plus').disabled = state.notes >= 17;

      // Nom de la configuration
      const configName = `${rootDisplay} ${scaleData.name} ${state.notes} notes`;
      
      // Vérifier la faisabilité AVANT de calculer le prix
      let feasibilityStatus = 'ok';
      if (typeof FeasibilityModule !== 'undefined') {
        const result = FeasibilityModule.checkFeasibility(notes, state.size);
        feasibilityStatus = result.status;
      }

      // Store instrument price for later use
      state._instrumentPrice = calculatePrice(notes, state.size, feasibilityStatus, state.material);
      state._feasibilityStatus = feasibilityStatus;
      state._configName = configName;
      state._rootDisplay = rootDisplay;
      state._scaleData = scaleData;

      // Render accessoires section (depends on size)
      renderAccessoiresSection();

      // Update price display (includes housse if selected)
      updatePriceDisplay();

      // Mettre à jour l'UI de faisabilité (chips, hint, bouton)
      if (typeof FeasibilityModule !== 'undefined') {
        FeasibilityModule.update(state, notes, SCALES_DATA, parsePattern, {
          configName: configName
        });
      }

      renderPlayer();
    }

    // ===== UPDATE PRICE DISPLAY =====
    function updatePriceDisplay() {
      const instrumentPrice = state._instrumentPrice || 0;
      const houssePrice = state.housse ? (state.housse.prix || 0) : 0;
      const totalPrice = instrumentPrice + houssePrice;

      // Update price breakdown
      const priceBreakdown = document.getElementById('price-breakdown');
      const priceInstrument = document.getElementById('price-instrument');
      const priceHousseLine = document.getElementById('price-housse-line');
      const priceHousse = document.getElementById('price-housse');

      if (state.housse && priceBreakdown) {
        priceBreakdown.style.display = 'block';
        if (priceInstrument) priceInstrument.textContent = instrumentPrice.toLocaleString('fr-FR') + ' €';
        if (priceHousseLine) priceHousseLine.style.display = 'block';
        if (priceHousse) priceHousse.textContent = houssePrice.toLocaleString('fr-FR') + ' €';
      } else if (priceBreakdown) {
        priceBreakdown.style.display = 'none';
        if (priceHousseLine) priceHousseLine.style.display = 'none';
      }

      // Update total price
      document.getElementById('total-price').textContent = totalPrice.toLocaleString('fr-FR') + ' €';

      // Update order URL
      const orderParams = new URLSearchParams({
        scale: state.scale,
        tonality: state.tonality,
        notes: state.notes,
        tuning: state.tuning,
        size: state.size,
        material: state.material,
        price: totalPrice,
        instrument_price: instrumentPrice,
        name: `${state._rootDisplay || ''} ${state._scaleData?.name || ''}`
      });

      // Add housse info if selected
      if (state.housse) {
        orderParams.set('housse_id', state.housse.id);
        orderParams.set('housse_nom', state.housse.nom);
        orderParams.set('housse_prix', state.housse.prix);
      }

      const orderUrl = `commander.html?${orderParams.toString()}`;
      document.getElementById('btn-order').href = orderUrl;
      document.getElementById('btn-order').dataset.originalHref = orderUrl;
    }
    
    // ===== RENDER MATERIAL CARDS =====
    function renderMaterialCards() {
      const container = document.getElementById('cards-material');
      if (!container) return;

      // Récupérer les matériaux depuis le module
      const materiaux = typeof MistralMateriaux !== 'undefined'
        ? MistralMateriaux.getForConfigurateur()
        : [
            { code: 'NS', nom: 'Acier Nitruré', nom_court: 'Nitrure', prix_malus: 0 },
            { code: 'ES', nom: 'Ember Steel', nom_court: 'Ember Steel', prix_malus: 5 },
            { code: 'SS', nom: 'Acier Inoxydable', nom_court: 'Inox', prix_malus: 10 }
          ];

      let html = '';
      materiaux.forEach(mat => {
        const isActive = mat.code === state.material ? ' active' : '';
        const priceInfo = mat.prix_malus > 0 ? `<div class="radio-card__price">+${mat.prix_malus}%</div>` : '';
        html += `
          <div class="radio-card${isActive}" data-value="${mat.code}">
            <div class="radio-card__value">${mat.nom_court || mat.nom}</div>
            <div class="radio-card__label">${mat.nom}</div>
            ${priceInfo}
          </div>
        `;
      });

      container.innerHTML = html;

      // Bind events
      container.querySelectorAll('.radio-card').forEach(card => {
        card.addEventListener('click', () => {
          container.querySelectorAll('.radio-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          state.material = card.dataset.value;
          updateDisplay();
        });
      });
    }

    // ===== RENDER ACCESSOIRES (HOUSSE) =====
    function getAccessoiresForConfigurateur(size) {
      // Get accessoires from localStorage (same source as boutique-admin)
      try {
        const stored = localStorage.getItem('mistral_accessoires');
        if (stored) {
          const accessoires = JSON.parse(stored);
          return accessoires.filter(a =>
            a.statut === 'actif' &&
            a.visible_configurateur === true &&
            a.tailles_compatibles &&
            a.tailles_compatibles.includes(size)
          );
        }
      } catch (e) {
        console.warn('[Configurateur] Erreur lecture accessoires:', e);
      }
      return [];
    }

    function renderAccessoiresSection() {
      const section = document.getElementById('accessoires-section');
      const container = document.getElementById('accessoires-list');
      if (!section || !container) return;

      const accessoires = getAccessoiresForConfigurateur(state.size);

      // Hide section if no accessoires available
      if (accessoires.length === 0) {
        section.style.display = 'none';
        // Reset housse selection if current housse is not available
        if (state.housse) {
          state.housse = null;
        }
        return;
      }

      section.style.display = 'block';

      // Check if current housse is still available for this size
      if (state.housse && !accessoires.find(a => a.id === state.housse.id)) {
        state.housse = null;
      }

      let html = `
        <div class="accessoire-card accessoire-card--none${!state.housse ? ' active' : ''}" data-id="">
          <div class="accessoire-card__content">
            <div class="accessoire-card__name">Sans housse</div>
            <div class="accessoire-card__price">—</div>
          </div>
        </div>
      `;

      accessoires.forEach(acc => {
        const isActive = state.housse && state.housse.id === acc.id ? ' active' : '';
        const hasImage = acc.image;
        const imageHtml = hasImage
          ? `<div class="accessoire-card__image"><img src="${acc.image}" alt="${escapeHtmlForAccessoire(acc.nom)}"></div>`
          : '';

        html += `
          <div class="accessoire-card${isActive}" data-id="${acc.id}">
            ${imageHtml}
            <div class="accessoire-card__content">
              <div class="accessoire-card__name">${escapeHtmlForAccessoire(acc.nom)}</div>
              <div class="accessoire-card__price">+${Number(acc.prix).toLocaleString('fr-FR')} €</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // Bind events
      container.querySelectorAll('.accessoire-card').forEach(card => {
        card.addEventListener('click', () => {
          container.querySelectorAll('.accessoire-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');

          const id = card.dataset.id;
          if (id) {
            state.housse = accessoires.find(a => a.id === id) || null;
          } else {
            state.housse = null;
          }
          updatePriceDisplay();
        });
      });
    }

    function escapeHtmlForAccessoire(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // ===== BIND EVENTS =====
    function bindEvents() {
      const toggleBtn = document.getElementById('toggle-advanced');
      const advancedContent = document.getElementById('advanced-content');
      toggleBtn.addEventListener('click', () => {
        toggleBtn.classList.toggle('open');
        advancedContent.classList.toggle('open');
      });
      
      document.getElementById('notes-minus').addEventListener('click', () => {
        if (state.notes > 9) { state.notes--; updateDisplay(); }
      });
      document.getElementById('notes-plus').addEventListener('click', () => {
        if (state.notes < 17) { state.notes++; updateDisplay(); }
      });
      
      document.querySelectorAll('#chips-scale .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('#chips-scale .chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          state.scale = chip.dataset.value;
          
          const scaleData = SCALES_DATA[state.scale];
          state.tonality = scaleData.baseRoot + scaleData.baseOctave;
          document.querySelectorAll('#chips-tonality .chip').forEach(c => {
            c.classList.toggle('active', c.dataset.value === state.tonality);
          });

          // Update chip labels to match scale notation (Gb/Ab/Bb for Kurd, F#/G#/A# for Hijaz)
          updateTonalityChipsLabels();

          updateDisplay();
        });
      });
      
      document.querySelectorAll('#chips-tonality .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          // Ne pas changer si le chip est désactivé
          if (chip.disabled || chip.classList.contains('chip--disabled')) return;

          document.querySelectorAll('#chips-tonality .chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          state.tonality = chip.dataset.value;

          // Update chip labels based on new tonality (sharp root = sharps, natural = scale pref)
          updateTonalityChipsLabels();

          updateDisplay();
        });
      });
      
      document.querySelectorAll('#cards-tuning .radio-card').forEach(card => {
        card.addEventListener('click', () => {
          document.querySelectorAll('#cards-tuning .radio-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          state.tuning = card.dataset.value;
          updateDisplay();
        });
      });
      
      document.querySelectorAll('#cards-size .radio-card').forEach(card => {
        card.addEventListener('click', () => {
          document.querySelectorAll('#cards-size .radio-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          state.size = card.dataset.value;
          updateDisplay();
        });
      });
      
      document.getElementById('btn-play').addEventListener('click', playScale);
    }
    
    async function playScale() {
      const btn = document.getElementById('btn-play');
      const notes = getCurrentNotes();
      const sortedNotes = [...notes].sort((a, b) => a.freq - b.freq);
      
      btn.classList.add('playing');
      btn.querySelector('span').textContent = '...';
      
      for (let i = 0; i < sortedNotes.length; i++) {
        await delay(280);
        const noteName = `${sortedNotes[i].note}${sortedNotes[i].octave}`;
        playNote(noteName);
        
        const noteGroups = document.querySelectorAll('.note-group');
        noteGroups.forEach(g => {
          if (g.dataset.note === noteName) {
            g.classList.add('active');
            setTimeout(() => g.classList.remove('active'), 280);
          }
        });
      }
      
      btn.classList.remove('playing');
      btn.querySelector('span').textContent = 'Écouter';
    }
    
    function delay(ms) {
      return new Promise(r => setTimeout(r, ms));
    }
    
    // ===== SWIPE NAVIGATION SYSTEM =====
    (function() {
      const wrapper = document.getElementById('boutique-wrapper');
      const tabs = document.querySelectorAll('.boutique-tab');
      const dots = document.querySelectorAll('.boutique-dot');
      const panelConfig = document.getElementById('panel-config');
      const panelStock = document.getElementById('panel-stock');
      
      // Nav band elements
      const navBand = document.getElementById('nav-band');
      const navBandBtn = document.getElementById('nav-band-btn');
      const navBandText = document.getElementById('nav-band-text');
      const navBandBadge = document.getElementById('nav-band-badge');
      const navBandCount = document.getElementById('nav-band-count');
      const arrowDown = document.getElementById('nav-arrow-down');
      const arrowUp = document.getElementById('nav-arrow-up');
      
      let currentSection = 'config'; // 'config' or 'stock'
      
      if (!wrapper) return;
      
      // Update active state based on scroll position
      function updateActiveState(panel) {
        tabs.forEach(tab => {
          tab.classList.toggle('active', tab.dataset.panel === panel);
        });
        dots.forEach(dot => {
          dot.classList.toggle('active', dot.dataset.panel === panel);
        });
      }
      
      // Update nav band state
      function updateNavBand(section) {
        if (!navBand || window.innerWidth <= 768) return;
        
        currentSection = section;
        
        if (section === 'config') {
          navBandText.textContent = 'Instruments en stock';
          arrowDown.style.display = 'block';
          arrowUp.style.display = 'none';
          if (navBandBadge) navBandBadge.style.display = 'inline-flex';
          navBand.classList.remove('is-stock');
        } else {
          navBandText.textContent = 'Créer sur mesure';
          arrowDown.style.display = 'none';
          arrowUp.style.display = 'block';
          if (navBandBadge) navBandBadge.style.display = 'none';
          navBand.classList.add('is-stock');
        }
      }
      
      // Scroll to panel
      function scrollToPanel(panel) {
        const target = panel === 'config' ? panelConfig : panelStock;
        if (target) {
          // Mobile: horizontal scroll
          if (window.innerWidth <= 768) {
            wrapper.scrollTo({
              left: target.offsetLeft,
              behavior: 'smooth'
            });
          } else {
            // Desktop: vertical scroll
            if (panel === 'config') {
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
              // Scroll to stock section (after nav band)
              const stockSection = document.getElementById('flash-sales');
              if (stockSection) {
                stockSection.scrollIntoView({ behavior: 'smooth' });
              }
            }
          }
        }
      }
      
      // Tab click handlers
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          scrollToPanel(tab.dataset.panel);
        });
      });
      
      // Dot click handlers
      dots.forEach(dot => {
        dot.addEventListener('click', () => {
          scrollToPanel(dot.dataset.panel);
        });
      });
      
      // Nav band click handler
      if (navBandBtn) {
        navBandBtn.addEventListener('click', () => {
          if (currentSection === 'config') {
            scrollToPanel('stock');
          } else {
            scrollToPanel('config');
          }
        });
      }
      
      // Detect scroll position on mobile (horizontal)
      let scrollTimeout;
      wrapper.addEventListener('scroll', () => {
        if (window.innerWidth > 768) return;
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          const scrollLeft = wrapper.scrollLeft;
          const panelWidth = wrapper.offsetWidth;
          const activePanel = scrollLeft < panelWidth / 2 ? 'config' : 'stock';
          updateActiveState(activePanel);
        }, 50);
      });
      
      // Detect scroll position on desktop (vertical)
      function checkDesktopScroll() {
        if (window.innerWidth <= 768) return;
        
        if (!navBand) return;
        
        // Check if nav band is stuck (at top under header)
        const navBandRect = navBand.getBoundingClientRect();
        const headerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height') || '64');
        
        // If the nav band is stuck at the top (its top equals header height), we're in stock mode
        const isStuck = navBandRect.top <= headerHeight + 2; // +2 for tolerance
        
        if (isStuck) {
          updateNavBand('stock');
        } else {
          updateNavBand('config');
        }
      }
      
      // Throttled scroll handler for desktop
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            checkDesktopScroll();
            ticking = false;
          });
          ticking = true;
        }
      });
      
      // Update stock count in tab and nav band
      function updateStockCount() {
        const stockCountTab = document.getElementById('stock-count-tab');
        let count = 0;

        if (typeof MistralAdmin !== 'undefined' && MistralAdmin.FlashAnnonces && typeof MistralAdmin.FlashAnnonces.getActive === 'function') {
          const annonces = MistralAdmin.FlashAnnonces.getActive();
          count = annonces.length;
        }
        
        if (stockCountTab) {
          stockCountTab.textContent = count;
        }
        
        if (navBandCount) {
          navBandCount.textContent = count;
        }
      }
      
      // Expose scrollToStock for compatibility
      window.scrollToStock = function() {
        scrollToPanel('stock');
      };
      
      // Init
      setTimeout(() => {
        updateStockCount();
        checkDesktopScroll();
      }, 100);
      window.addEventListener('storageUpdate', updateStockCount);
      window.addEventListener('stockUpdated', (e) => {
        const count = e.detail?.count || 0;
        if (document.getElementById('stock-count-tab')) {
          document.getElementById('stock-count-tab').textContent = count;
        }
        if (navBandCount) {
          navBandCount.textContent = count;
        }
      });
      window.addEventListener('resize', checkDesktopScroll);
    })();
    
    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      renderMaterialCards();  // Render material cards first
      bindEvents();
      updateTonalityChipsLabels();  // Set chip labels based on default scale (Kurd = flats)
      updateDisplay();

      // Listen for material updates from admin
      window.addEventListener('materiauxUpdated', () => {
        renderMaterialCards();
        updateDisplay();
      });
    });
  </script>
  
  <!-- Scripts -->
  
  <script src="js/cookie-consent.js"></script>
  <script src="js/main.js"></script>
  <script src="js/handpan-player.js"></script>

  <!-- Admin Scripts -->
  <script src="js/admin-core.js"></script>
  <script src="js/boutique-admin.js"></script>
<script src="js/mistral-stats.js"></script>
</body>
</html>
